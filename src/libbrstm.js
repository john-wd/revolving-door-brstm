//
// COMPILED VERSION OF A MODIFIED BRSTM MODULE
// SOURCE CODE IN brstm/ DIRECTORY
// THIS CHANGE IS MOSTLY SO THAT FIX INTRODUCED BY #14 GETS ADDRESSD IN OUR BUILDS.
//
function t(t,a,e){for(var s=[],r=a;r<a+e;r++)s.push(t[r]);return s}function a(a,e,s){return t(a,e,s).reduce(function(t,a){return 256*t+a},0)}function e(t,a,e){return t<=a?a:t>=e?e:t}function s(t){return t>=32768?t-65536:t}exports.Brstm=function(){function r(e){if(this.rawData=new Uint8Array(e),"RSTM"!==(s=t(this.rawData,0,4),String.fromCharCode.apply(String,s)))throw new Error("Not a valid BRSTM file");var s;this._offsetToHead=a(this.rawData,16,4),this._offsetToHeadChunk1=this._offsetToHead+a(this.rawData,this._offsetToHead+12,4)+8,this._offsetToHeadChunk2=this._offsetToHead+a(this.rawData,this._offsetToHead+20,4)+8,this._offsetToHeadChunk3=this._offsetToHead+a(this.rawData,this._offsetToHead+28,4)+8,this._offsetToAdpc=a(this.rawData,24,4),this._offsetToData=a(this.rawData,32,4),this.metadata=this._getMetadata(),this._cachedSamples=null,this._partitionedAdpcChunkData=null,this._cachedChannelInfo=null,this._cachedBlockResults=[]}var o=r.prototype;return o._getChannelInfo=function(){if(this._cachedChannelInfo)return this._cachedChannelInfo;for(var t=this.metadata.numberChannels,e=[],r=0;r<t;r++){for(var o=this._offsetToHead+a(this.rawData,this._offsetToHeadChunk3+8+8*r,4)+8+8,i=[],h=0;h<16;h++){var n=a(this.rawData,o+2*h,2);i.push(s(n))}e.push({adpcmCoefficients:i,gain:a(this.rawData,o+40,2),initialPredictorScale:a(this.rawData,o+42,2),historySample1:a(this.rawData,o+44,2),historySample2:a(this.rawData,o+46,2),loopPredictorScale:a(this.rawData,o+48,2),loopHistorySample1:a(this.rawData,o+50,2),loopHistorySample2:a(this.rawData,o+52,2)})}return this._cachedChannelInfo=e,e},o._getMetadata=function(){var t=a(this.rawData,this._offsetToHeadChunk1+2,1);return{fileSize:a(this.rawData,8,4),codec:a(this.rawData,this._offsetToHeadChunk1,1),loopFlag:a(this.rawData,this._offsetToHeadChunk1+1,1),numberChannels:t,sampleRate:a(this.rawData,this._offsetToHeadChunk1+4,2),loopStartSample:a(this.rawData,this._offsetToHeadChunk1+8,4),totalSamples:a(this.rawData,this._offsetToHeadChunk1+12,4),totalBlocks:a(this.rawData,this._offsetToHeadChunk1+20,4),blockSize:a(this.rawData,this._offsetToHeadChunk1+24,4),samplesPerBlock:a(this.rawData,this._offsetToHeadChunk1+28,4),finalBlockSize:a(this.rawData,this._offsetToHeadChunk1+32,4),finalBlockSizeWithPadding:a(this.rawData,this._offsetToHeadChunk1+40,4),totalSamplesInFinalBlock:a(this.rawData,this._offsetToHeadChunk1+36,4),adpcTableSamplesPerEntry:a(this.rawData,this._offsetToHeadChunk1+44,4),adpcTableBytesPerEntry:a(this.rawData,this._offsetToHeadChunk1+48,4),numberTracks:a(this.rawData,this._offsetToHeadChunk2,1),trackDescriptionType:a(this.rawData,this._offsetToHeadChunk2+1,1)}},o._getPartitionedBlockData=function(t){for(var a=this.metadata,e=a.blockSize,s=a.totalBlocks,r=a.numberChannels,o=a.finalBlockSize,i=a.finalBlockSizeWithPadding,h=[],n=0;n<r;n++)h.push(new Uint8Array(t===s-1?o:e));for(var f=t,l=0;l<r;l++){var c=0!==l&&f+1===s?f*r*e+l*i:(f*r+l)*e,u=this.rawData.slice(this._offsetToData+32+c,this._offsetToData+32+(f+1===s?c+o:c+e));h[l].set(u)}return h},o._getPartitionedAdpcChunkData=function(){if(this._partitionedAdpcChunkData)return this._partitionedAdpcChunkData;for(var t=this.metadata,e=t.totalBlocks,r=t.numberChannels,o=a(this.rawData,this._offsetToAdpc+4,4),i=this.rawData.slice(this._offsetToAdpc+8,this._offsetToAdpc+8+o),h=0,n=0,f=0,l=0;l<r;l++)n=s(a(i,h,2)),f=s(a(i,h+=2,2)),h+=2;for(var c=[],u=0;u<e;u++){c.push([]);for(var d=0;d<r;d++)u>0&&(n=s(a(i,h,2)),f=s(a(i,h+=2,2)),h+=2),c[u].push({yn1:n,yn2:f})}for(var p=[],_=function(t){p.push(c.map(function(a){return a[t]}))},k=0;k<r;k++)_(k);return this._partitionedAdpcChunkData=p,p},o.getAllSamples=function(){if(this._cachedSamples)return this._cachedSamples;for(var t=this.metadata,a=t.numberChannels,e=t.totalSamples,s=t.totalBlocks,r=t.samplesPerBlock,o=[],i=0;i<a;i++)o.push(new Int16Array(e));for(var h=0;h<s;h++)for(var n=this._getSamplesAtBlock(h),f=0;f<a;f++)o[f].set(n[f],h*r);return this._cachedSamples=o,o},o._getSamplesAtBlock=function(t){if(this._cachedBlockResults[t])return this._cachedBlockResults[t];for(var r=this.metadata,o=r.numberChannels,i=r.totalBlocks,h=r.totalSamplesInFinalBlock,n=r.samplesPerBlock,f=r.codec,l=this._getChannelInfo(),c=this._getPartitionedBlockData(t),u=this._getPartitionedAdpcChunkData(),d=[],p=t===i-1?h:n,_=0;_<o;_++)d.push(new Int16Array(p));for(var k=0;k<o;k++){var m=l[k].adpcmCoefficients,D=c[k],w=[];if(2===f){for(var C=u[k][t],T=D[0],v=C.yn1,S=C.yn2,H=0,B=0;B<p;){var g=0;B%14==0&&(T=D[H++]),(g=0==(1&B++)?D[H]>>4:15&D[H++])>=8&&(g-=16);var y=T>>4<<1;g=1024+((1<<(15&T))*g<<11)+m[e(y,0,15)]*v+m[e(y+1,0,15)]*S>>11,S=v,v=e(g,-32768,32767),w.push(v)}t<i-1&&(u[k][t+1].yn1=w[p-1],u[k][t+1].yn2=w[p-2])}else if(1===f)for(var A=0;A<p;A++){var P=s(a(D,2*A,2));w.push(P)}else{if(0!==f)throw new Error("Invalid codec");for(var b=0;b<p;b++)w.push(s(D[b]))}d[k].set(w)}return this._cachedBlockResults[t]=d,d},o.getBuffer=function(t,a){return this.getSamples(t,a)},o.getSamples=function(t,a){for(var e=this.metadata,s=e.numberChannels,r=e.totalBlocks,o=e.totalSamples,i=e.samplesPerBlock,h=Math.max(0,t),n=Math.min(o,t+a),f=Math.max(0,Math.floor(h/i)),l=Math.min(r-1,Math.floor(n/i)),c=[],u=f;u<=l;u++)c.push(this._getSamplesAtBlock(u));for(var d=[],p=0;p<s;p++)d.push(new Int16Array(n-h));for(var _=f;_<=l;_++){var k=_-f;if(_===f&&_===l)for(var m=0;m<s;m++)d[m].set(c[k][m].slice(h-f*i,h-f*i+a),0);else if(_===f)for(var D=0;D<s;D++){var w=c[k][D].slice(h-f*i);d[D].set(w,0)}else if(_===l)for(var C=0;C<s;C++){var T=c[k][C].slice(0,n-c[k][C].length-f*i);d[C].set(T.length+(_*i-h)>d[C].length?T.slice(0,a-(_*i-h)):T,_*i-h)}else for(var v=0;v<s;v++)d[v].set(c[k][v],_*i-h)}return d},r}();
