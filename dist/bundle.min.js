!function(){"use strict";class t{constructor(){this.registerOpEvent=function(t,e){if(this.operationListeners.has(t)){let s=this.operationListeners.get(t);s.push(e),this.operationListeners.set(t,s)}else this.operationListeners.set(t,[e])},this.registerFinEvent=function(t,e){if(this.finishedListeners.has(t)){let s=this.finishedListeners.get(t);s.push(e),this.finishedListeners.set(t,s)}else this.finishedListeners.set(t,[e])},this.currentlyGesturing=!1,this.activeArea="",this.activeAreaElem=null,this.operationListeners=new Map,this.finishedListeners=new Map}sanitize(t,e){let s=this.activeAreaElem.getBoundingClientRect(),a=t-s.x,i=e-s.y;return a<0&&(a=0),i<0&&(i=0),a>s.width&&(a=s.width),i>s.height&&(i=s.height),[a,i]}fireOp(t,e,s){if(this.operationListeners.has(t))for(let a=0;a<this.operationListeners.get(t).length;a++)this.operationListeners.get(t)[a](e,s)}fireFin(t,e,s){if(this.finishedListeners.has(t))for(let a=0;a<this.finishedListeners.get(t).length;a++)this.finishedListeners.get(t)[a](e,s)}runGestureEngine(){s()}}let e=new t;function s(){document.addEventListener("mousedown",(function(t){if(t.target.dataset.gestureHitzone){e.currentlyGesturing=!0,e.activeArea=t.target.dataset.gestureHitzone,e.activeAreaElem=t.target;let[s,a]=e.sanitize(t.clientX,t.clientY);e.fireOp(e.activeArea,s,a)}})),document.addEventListener("mousemove",(function(t){if(e.currentlyGesturing){let[s,a]=e.sanitize(t.clientX,t.clientY);e.fireOp(e.activeArea,s,a)}})),document.addEventListener("mouseup",(function(t){if(e.currentlyGesturing){let[s,a]=e.sanitize(t.clientX,t.clientY);e.fireFin(e.activeArea,s,a),e.currentlyGesturing=!1,e.activeAreaElem=null,e.activeArea=""}}))}function a(t){if(t.__esModule)return t;var e=Object.defineProperty({},"__esModule",{value:!0});return Object.keys(t).forEach((function(s){var a=Object.getOwnPropertyDescriptor(t,s);Object.defineProperty(e,s,a.get?a:{enumerable:!0,get:function(){return t[s]}})})),e}var i=a(Object.freeze({__proto__:null,getInstance:function(){return null==e&&(e=new t),e},runGestureEngine:s}));const n=Math.pow(2,19),o="brstm_player";var l;!function(t){t.start="brstm_start",t.play="brstm_play",t.pause="brstm_pause",t.playPause="brstm_playpause",t.stop="brstm_stop",t.next="brstm_next",t.previous="brstm_previous",t.seek="brstm_seek",t.setLoop="brstm_setloop",t.setVolume="brstm_setvolume",t.buffering="brstm_buffering",t.loading="brstm_loading",t.loaded="brstm_loaded",t.killed="brstm_killed",t.step="brstm_step",t.resetState="brstm_resetstate"}(l||(l={}));const r=i.getInstance();let h={display:!1,position:0,samples:1e6,loaded:5e5,volume:1,paused:!1,ready:!1,buffering:!1,sampleRate:48e3,looping:!1,streamingDied:!1},u={volume:null,position:null},d={},c=null,p=null,f=null,m=-30;function g(t){try{t.preventDefault()}catch(t){}if(t.targetTouches.length>0){let e=t.targetTouches[0].target.getBoundingClientRect(),s=t.targetTouches[0].clientY+t.targetTouches[0].radiusY-e.top;s<5&&(s=0),s>80&&(s=84);let a=1-s/84;u.volume=a,"touchend"===t.type&&(h.volume=u.volume,d.setVolume(u.volume),u.volume=null,localStorage.setItem("volumeoverride",a)),A()}else"touchend"===t.type&&(h.volume=u.volume,d.setVolume(u.volume),u.volume=null)}function y(t){try{t.preventDefault()}catch(t){}if(t.targetTouches.length>0){let e=t.targetTouches[0].target.getBoundingClientRect(),s=t.targetTouches[0].clientX+t.targetTouches[0].radiusX-e.left;if(s<5&&(s=0),s>254&&(s=254),s=Math.round(s),s===m)return;m=s;let a=h.samples*(s/254);a<h.loaded&&(u.position=a),"touchend"===t.type&&(d.seek(u.position),u.position=null),A()}else"touchend"===t.type&&(d.seek(u.position),u.position=null)}function v(t,e){let s=Math.round(t),a=h.samples*(s/254);a<h.loaded&&(u.position=a),A()}function _(t,e){let s=Math.round(t),a=h.samples*(s/254);a<h.loaded&&(u.position=a),d.seek(a),u.position=null,A()}function b(t,e){e=Math.round(e),u.volume=1-e/84,A()}function w(t,e){let s=1-(e=Math.round(e))/84;u.volume=null,localStorage.setItem("volumeoverride",s),d.setVolume(s),A()}let S=null,k=null,E=-1,L=-1,R=null,C=-1,x=-1,M=null,B=-1,D=null;function A(){if(h.display&&(f.style.display="block"),f){D!==h.streamingDied&&(f.querySelector(".error").style.display=h.streamingDied?"flex":"none",D=h.streamingDied);let t=h.buffering||!h.ready;if(S!==t&&(f.querySelector("#gui-loading-bar").dataset.exists=t,S=t),k!==h.ready&&(f.querySelector('.guistate[data-guistate="preload"]').style.display=h.ready?"none":"block",f.querySelector('.guistate[data-guistate="ready"]').style.display=h.ready?"grid":"none",k=h.ready),!h.ready)return;let e=Math.round(84-84*h.volume);null!==u.volume&&(e=Math.round(84-84*u.volume)),e!==E&&(c.fillStyle="#444",c.fillRect(0,0,16,84),c.fillStyle="hsl(200, 85%, 55%)",c.fillRect(0,e,16,84),E=e);let s=Math.ceil(h.position/h.samples*254);null!==u.position&&(s=Math.ceil(u.position/h.samples*254));let a=Math.ceil(h.loaded/h.samples*254);s===L&&a===B||(p.fillStyle="#222",p.fillRect(0,0,254,16),p.fillStyle="#666",p.fillRect(0,0,Math.min(254,a),16),p.fillStyle="hsl(200, 85%, 55%)",p.fillRect(0,0,Math.min(254,s),16),L=s,B=a),R!==h.paused&&(f.querySelector("#pl-pause").style.display=h.paused?"none":"block",f.querySelector("#pl-play").style.display=h.paused?"block":"none",R=h.paused);let i=Math.floor(h.samples/h.sampleRate),n=Math.floor(h.position/h.sampleRate);null!==u.position&&(n=Math.floor(u.position/h.sampleRate)),i!==C&&(f.querySelector("#pl-time-end").innerText=`${Math.floor(i/60)}:${(i%60).toString().padStart(2,"0")}`,C=i),n!==x&&(f.querySelector("#pl-time-start").innerText=`${Math.floor(n/60)}:${(n%60).toString().padStart(2,"0")}`,x=n),M!==h.looping&&(f.querySelector("#pl-loop-box").checked=h.looping,M=h.looping)}}var T=Object.freeze({__proto__:null,runGUI:function(t){!function(){let t=document.getElementById(o);t&&(t.addEventListener(l.step,(t=>{h=Object.assign(Object.assign({},h),{position:t.detail.position,paused:t.detail.paused,volume:t.detail.volume,loaded:t.detail.loaded,looping:t.detail.looping}),A()})),t.addEventListener(l.killed,(t=>{console.log(t),h=Object.assign(Object.assign({},h),{streamingDied:t.detail.streamingDied,buffering:t.detail.buffering,ready:t.detail.ready}),A()})),t.addEventListener(l.setVolume,(t=>{console.log(t),h.volume=t.detail.volume,A()})),t.addEventListener(l.seek,(t=>{console.log(t),h.position=t.detail.toSample,A()})),t.addEventListener(l.playPause,(t=>{console.log(t),h.paused=t.detail.playing,A()})),t.addEventListener(l.setLoop,(t=>{console.log(t),h.looping=t.detail.loop,A()})),t.addEventListener(l.stop,(t=>{console.log(t),f&&(h.display=!1,f.style.display="none")})),t.addEventListener(l.start,(t=>{console.log(t),h.loaded=t.detail.loaded,h.display=!0,A()})),t.addEventListener(l.resetState,(t=>{console.log(t),h=Object.assign(Object.assign({},h),{ready:t.detail.ready,position:t.detail.position,samples:t.detail.samples,loaded:t.detail.loaded,volume:t.detail.volume,paused:t.detail.paused,buffering:t.detail.buffering,sampleRate:t.detail.sampleRate,streamingDied:t.detail.streamingDied}),A()})),t.addEventListener(l.loaded,(t=>{console.log(t),h=Object.assign(Object.assign({},h),{ready:t.detail.ready,samples:t.detail.samples,sampleRate:t.detail.sampleRate}),A()})),t.addEventListener(l.buffering,(t=>{h.buffering=t.detail.buffering,A()})))}(),d=t,f=document.createElement("div"),f.style.display="none",f.classList.add("guiholder"),f.innerHTML='\n<div class="error" style="display: none">\n    <h3>Playback failed!</h3>\n    <h3>Reload the page and try again.</h3>\n    <h3>If the issue continues, contact us.</h3>\n</div>\n<div id="gui-loading-bar">\n    <div id="gui-inner-loading-bar"></div>\n</div>\n<div class="guistate" data-guistate="preload">\n    <h3>Loading song...</h3>\n</div>\n<div class="guistate" data-guistate="ready">\n    <div id="pl-pause-play">\n        <svg width="48" height="48" viewBox="0 0 48 48" id="pl-play">\n            <path d="M 10, 10 l 0, 28 l 28, -14" fill="white"></path>\n        </svg>\n        <svg width="48" height="48" viewBox="0 0 48 48" id="pl-pause" style="display: none;">\n            <path d="M 10, 10 l 0, 28 l 10, 0 l 0, -28 M 28, 10 l 0, 28 l 10, 0 l 0, -28" fill="white"></path>\n        </svg>\n    </div>\n    <canvas id="pl-volume" width="16" height="84" data-gesture-hitzone="volume"></canvas>\n    <div id="pl-timing">\n        <span id="pl-time-start">0:00</span>\n        <span id="pl-time-end"  >0:00</span>\n    </div>\n    <canvas id="pl-seek" width="254" height="16" data-gesture-hitzone="seek"></canvas>\n    <div id="pl-loop">\n        <input type="checkbox" id="pl-loop-box" style="width: 16px; height: 16px; margin: 0;">\n        <span class="pl-loop-text">Enable loop</span>\n        <a class="pl-loop-text" target="_blank" href="https://smashcustommusic.net/feedback/">Send feedback</a>\n        <a class="pl-loop-text" target="_blank" href="https://github.com/rphsoftware/revolving-door">v2 by Rph</a>\n    </div>\n</div>',document.body.appendChild(f),c=document.querySelector("#pl-volume").getContext("2d"),p=document.querySelector("#pl-seek").getContext("2d"),document.querySelector("#pl-volume").addEventListener("touchstart",g),document.querySelector("#pl-volume").addEventListener("touchmove",g),document.querySelector("#pl-volume").addEventListener("touchend",g),document.querySelector("#pl-seek").addEventListener("touchstart",y),document.querySelector("#pl-seek").addEventListener("touchmove",y),document.querySelector("#pl-seek").addEventListener("touchend",y),document.querySelector("#pl-pause-play").addEventListener("click",(function(){d.playPause(),A()})),document.querySelector("#pl-loop-box").addEventListener("input",(function(){h.looping=document.querySelector("#pl-loop-box").checked,d.setLoop(h.looping)})),f.addEventListener("drag",(function(t){t.preventDefault()})),r.runGestureEngine(),r.registerOpEvent("seek",v),r.registerFinEvent("seek",_),r.registerOpEvent("volume",b),r.registerFinEvent("volume",w)}}),P=a(T);function O(t,e){let s=this.getChannelData(e);for(let e=0;e<t.length;e++)s[e]=t[e]}class W{constructor(t,e,s,a){if(this._fromSampleRate=t,this._toSampleRate=e,this._channels=0|s,"object"!=typeof a)throw new Error("inputBuffer is not an object.");if(!(a instanceof Array||a instanceof Float32Array||a instanceof Float64Array))throw new Error("inputBuffer is not an array or a float32 or a float64 array.");this._inputBuffer=a,this.initialize()}initialize(){if(!(this._fromSampleRate>0&&this._toSampleRate>0&&this._channels>0))throw new Error("Invalid settings specified for the resampler.");this._fromSampleRate==this._toSampleRate?(this._resampler=this.bypassResampler,this._ratioWeight=1,this._outputBuffer=this._inputBuffer):(this._ratioWeight=this._fromSampleRate/this._toSampleRate,this._fromSampleRate<this._toSampleRate?(this.compileLinearInterpolationFunction(),this._lastWeight=1):(this.compileMultiTapFunction(),this.tailExists=!1,this._lastWeight=0),this.initializeBuffers())}initializeBuffers(){var t=Math.ceil(this._inputBuffer.length*this._toSampleRate/this._fromSampleRate/this._channels*1.0000004768371582)*this._channels+this._channels;try{this._outputBuffer=new Float32Array(t),this._lastOutput=new Float32Array(this._channels)}catch(t){this._outputBuffer=new Float32Array([]),this._lastOutput=new Float32Array([])}}bypassResampler(t){return t}compileMultiTapFunction(){for(var t="var outputOffset = 0;    if (bufferLength > 0) {        var buffer = this.inputBuffer;        var weight = 0;",e=0;e<this._channels;++e)t+="var output"+e+" = 0;";for(t+="var actualPosition = 0;        var amountToNext = 0;        var alreadyProcessedTail = !this.tailExists;        this.tailExists = false;        var outputBuffer = this.outputBuffer;        var currentPosition = 0;        do {            if (alreadyProcessedTail) {                weight = "+this._ratioWeight+";",e=0;e<this._channels;++e)t+="output"+e+" = 0;";for(t+="}            else {                weight = this.lastWeight;",e=0;e<this._channels;++e)t+="output"+e+" = this.lastOutput["+e+"];";for(t+="alreadyProcessedTail = true;            }            while (weight > 0 && actualPosition < bufferLength) {                amountToNext = 1 + actualPosition - currentPosition;                if (weight >= amountToNext) {",e=0;e<this._channels;++e)t+="output"+e+" += buffer[actualPosition++] * amountToNext;";for(t+="currentPosition = actualPosition;                    weight -= amountToNext;                }                else {",e=0;e<this._channels;++e)t+="output"+e+" += buffer[actualPosition"+(e>0?" + "+e:"")+"] * weight;";for(t+="currentPosition += weight;                    weight = 0;                    break;                }            }            if (weight <= 0) {",e=0;e<this._channels;++e)t+="outputBuffer[outputOffset++] = output"+e+" / "+this._ratioWeight+";";for(t+="}            else {                this.lastWeight = weight;",e=0;e<this._channels;++e)t+="this.lastOutput["+e+"] = output"+e+";";t+="this.tailExists = true;                break;            }        } while (actualPosition < bufferLength);    }    return outputOffset;",this._resampler=Function("bufferLength",t)}compileLinearInterpolationFunction(){for(var t="var outputOffset = 0;    if (bufferLength > 0) {        var buffer = this.inputBuffer;        var weight = this.lastWeight;        var firstWeight = 0;        var secondWeight = 0;        var sourceOffset = 0;        var outputOffset = 0;        var outputBuffer = this.outputBuffer;        for (; weight < 1; weight += "+this._ratioWeight+") {            secondWeight = weight % 1;            firstWeight = 1 - secondWeight;",e=0;e<this._channels;++e)t+="outputBuffer[outputOffset++] = (this.lastOutput["+e+"] * firstWeight) + (buffer["+e+"] * secondWeight);";t+="}        weight -= 1;        for (bufferLength -= "+this._channels+", sourceOffset = Math.floor(weight) * "+this._channels+"; sourceOffset < bufferLength;) {            secondWeight = weight % 1;            firstWeight = 1 - secondWeight;";for(e=0;e<this._channels;++e)t+="outputBuffer[outputOffset++] = (buffer[sourceOffset"+(e>0?" + "+e:"")+"] * firstWeight) + (buffer[sourceOffset + "+(this._channels+e)+"] * secondWeight);";t+="weight += "+this._ratioWeight+";            sourceOffset = Math.floor(weight) * "+this._channels+";        }";for(e=0;e<this._channels;++e)t+="this.lastOutput["+e+"] = buffer[sourceOffset++];";t+="this.lastWeight = weight % 1;    }    return outputOffset;",this._resampler=Function("bufferLength",t)}get outputBuffer(){return this._outputBuffer}get resampler(){return this._resampler}}var z=function(t,e,s,a){return new(s||(s=Promise))((function(i,n){function o(t){try{r(a.next(t))}catch(t){n(t)}}function l(t){try{r(a.throw(t))}catch(t){n(t)}}function r(t){var e;t.done?i(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(o,l)}r((a=a.apply(t,e||[])).next())}))};var F=function(t,e,s,a){return new(s||(s=Promise))((function(i,n){function o(t){try{r(a.next(t))}catch(t){n(t)}}function l(t){try{r(a.throw(t))}catch(t){n(t)}}function r(t){var e;t.done?i(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(o,l)}r((a=a.apply(t,e||[])).next())}))};var N=(t,e,s)=>{if(!e.has(t))throw TypeError("Cannot "+s)},I=(t,e,s)=>(N(t,e,"read from private field"),s?s.call(t):e.get(t)),j=(t,e,s)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,s)},U=(t,e,s,a)=>(N(t,e,"write to private field"),a?a.call(t,s):e.set(t,s),s),q=(t,e,s)=>(N(t,e,"access private method"),s);function G(t,e,s){const a=[];for(let i=e;i<e+s;i++)a.push(t[i]);return a}const V=0,H=1;function X(t,e,s,a=H){const i=G(t,e,s);return a===V&&i.reverse(),i.reduce(((t,e)=>256*t+e),0)}function $(t,e,s){return t<=e?e:t>=s?s:t}function Y(t){return t>=32768?t-65536:t}var J,K,Q,Z,tt,et,st,at,it,nt,ot,lt,rt,ht,ut,dt,ct,pt,ft,mt;class gt{constructor(t){if(j(this,ot),j(this,rt),j(this,ut),j(this,ct),j(this,ft),j(this,J,void 0),j(this,K,void 0),j(this,Q,void 0),j(this,Z,void 0),j(this,tt,void 0),j(this,et,void 0),j(this,st,void 0),j(this,at,void 0),j(this,it,void 0),j(this,nt,void 0),U(this,st,null),U(this,at,null),U(this,it,null),U(this,nt,[]),this.rawData=new Uint8Array(t),"RSTM"!==function(t,e,s,a=H){const i=G(t,e,s);return a===V&&i.reverse(),String.fromCharCode(...i)}(this.rawData,0,4))throw new Error("Not a valid BRSTM file");this.endianness=function(t){const e=G(t,4,2);return 255===e[0]&&254===e[1]?V:H}(this.rawData),U(this,J,X(this.rawData,16,4,this.endianness)),U(this,K,I(this,J)+X(this.rawData,I(this,J)+12,4,this.endianness)+8),U(this,Q,I(this,J)+X(this.rawData,I(this,J)+20,4,this.endianness)+8),U(this,Z,I(this,J)+X(this.rawData,I(this,J)+28,4,this.endianness)+8),U(this,tt,X(this.rawData,24,4,this.endianness)),U(this,et,X(this.rawData,32,4,this.endianness)),this.metadata=q(this,rt,ht).call(this)}getAllSamples(){if(I(this,st))return I(this,st);const{numberChannels:t,totalSamples:e,totalBlocks:s,samplesPerBlock:a}=this.metadata,i=[];for(let s=0;s<t;s++)i.push(new Int16Array(e));for(let e=0;e<s;e++){const s=q(this,ft,mt).call(this,e);for(let n=0;n<t;n++)i[n].set(s[n],e*a)}return U(this,st,i),i}getBuffer(t,e){return this.getSamples(t,e)}getSamples(t,e){const{numberChannels:s,totalBlocks:a,totalSamples:i,samplesPerBlock:n}=this.metadata,o=Math.max(0,t),l=Math.min(i,t+e),r=Math.max(0,Math.floor(o/n)),h=Math.min(a-1,Math.floor(l/n)),u=[];for(let t=r;t<=h;t++)u.push(q(this,ft,mt).call(this,t));const d=[];for(let t=0;t<s;t++)d.push(new Int16Array(l-o));for(let t=r;t<=h;t++){const a=t-r;if(t===r&&t===h)for(let t=0;t<s;t++)d[t].set(u[a][t].slice(o-r*n,o-r*n+e),0);else if(t===r)for(let t=0;t<s;t++){const e=u[a][t].slice(o-r*n);d[t].set(e,0)}else if(t===h)for(let i=0;i<s;i++){const s=u[a][i].slice(0,l-u[a][i].length-r*n);s.length+(t*n-o)>d[i].length?d[i].set(s.slice(0,e-(t*n-o)),t*n-o):d[i].set(s,t*n-o)}else for(let e=0;e<s;e++)d[e].set(u[a][e],t*n-o)}return d}}J=new WeakMap,K=new WeakMap,Q=new WeakMap,Z=new WeakMap,tt=new WeakMap,et=new WeakMap,st=new WeakMap,at=new WeakMap,it=new WeakMap,nt=new WeakMap,ot=new WeakSet,lt=function(){if(I(this,it))return I(this,it);const{numberChannels:t}=this.metadata,e=[];for(let s=0;s<t;s++){const t=I(this,J)+X(this.rawData,I(this,Z)+8+8*s,4,this.endianness)+8+8,a=[];for(let e=0;e<16;e++){const s=X(this.rawData,t+2*e,2,this.endianness);a.push(Y(s))}e.push({adpcmCoefficients:a,gain:X(this.rawData,t+40,2,this.endianness),initialPredictorScale:X(this.rawData,t+42,2,this.endianness),historySample1:X(this.rawData,t+44,2,this.endianness),historySample2:X(this.rawData,t+46,2,this.endianness),loopPredictorScale:X(this.rawData,t+48,2,this.endianness),loopHistorySample1:X(this.rawData,t+50,2,this.endianness),loopHistorySample2:X(this.rawData,t+52,2,this.endianness)})}return U(this,it,e),e},rt=new WeakSet,ht=function(){const t=X(this.rawData,I(this,K)+2,1,this.endianness),e=X(this.rawData,I(this,Q),1,this.endianness),s=X(this.rawData,I(this,Q)+1,1,this.endianness),a=[];for(let t=0;t<e;t++){const e=I(this,J)+8+X(this.rawData,I(this,Q)+4+8*t+4,4,this.endianness),s=X(this.rawData,I(this,Q)+4+8*t+1,1,this.endianness);let i=0;0===s?i=X(this.rawData,e,1,this.endianness):1===s&&(i=X(this.rawData,e+8,1,this.endianness)),a.push({numberChannels:i,type:s})}const i={fileSize:X(this.rawData,8,4,this.endianness),endianness:this.endianness,codec:X(this.rawData,I(this,K),1,this.endianness),loopFlag:X(this.rawData,I(this,K)+1,1,this.endianness),numberChannels:t,sampleRate:X(this.rawData,I(this,K)+4,2,this.endianness),loopStartSample:X(this.rawData,I(this,K)+8,4,this.endianness),totalSamples:X(this.rawData,I(this,K)+12,4,this.endianness),totalBlocks:X(this.rawData,I(this,K)+20,4,this.endianness),blockSize:X(this.rawData,I(this,K)+24,4,this.endianness),samplesPerBlock:X(this.rawData,I(this,K)+28,4,this.endianness),finalBlockSize:X(this.rawData,I(this,K)+32,4,this.endianness),finalBlockSizeWithPadding:X(this.rawData,I(this,K)+40,4,this.endianness),totalSamplesInFinalBlock:X(this.rawData,I(this,K)+36,4,this.endianness),adpcTableSamplesPerEntry:X(this.rawData,I(this,K)+44,4,this.endianness),adpcTableBytesPerEntry:X(this.rawData,I(this,K)+48,4,this.endianness),numberTracks:e,trackDescriptionType:s,trackDescriptions:a};return i.loopStartSample>=i.totalSamples&&(i.loopFlag=0,i.loopStartSample=0,console.warn("The loop start sample in this file is invalid.")),i},ut=new WeakSet,dt=function(t){const{blockSize:e,totalBlocks:s,numberChannels:a,finalBlockSize:i,finalBlockSizeWithPadding:n}=this.metadata,o=[];for(let n=0;n<a;n++)o.push(new Uint8Array(t===s-1?i:e));let l=t;for(let t=0;t<a;t++){const r=0!==t&&l+1===s?l*a*e+t*n:(l*a+t)*e,h=l+1===s?r+i:r+e,u=this.rawData.slice(I(this,et)+32+r,I(this,et)+32+h);o[t].set(u)}return o},ct=new WeakSet,pt=function(){if(I(this,at))return I(this,at);const{totalBlocks:t,numberChannels:e}=this.metadata,s=X(this.rawData,I(this,tt)+4,4,this.endianness),a=this.rawData.slice(I(this,tt)+8,I(this,tt)+8+s);let i=0,n=0,o=0;for(let t=0;t<e;t++)n=Y(X(a,i,2,this.endianness)),i+=2,o=Y(X(a,i,2,this.endianness)),i+=2;const l=[];for(let s=0;s<t;s++){l.push([]);for(let t=0;t<e;t++)s>0&&(n=Y(X(a,i,2,this.endianness)),i+=2,o=Y(X(a,i,2,this.endianness)),i+=2),l[s].push({yn1:n,yn2:o})}let r=[];for(let t=0;t<e;t++)r.push(l.map((e=>e[t])));return U(this,at,r),r},ft=new WeakSet,mt=function(t){if(I(this,nt)[t])return I(this,nt)[t];const{numberChannels:e,totalBlocks:s,totalSamplesInFinalBlock:a,samplesPerBlock:i,codec:n}=this.metadata,o=q(this,ot,lt).call(this),l=q(this,ut,dt).call(this,t),r=q(this,ct,pt).call(this),h=[],u=t===s-1?a:i;for(let t=0;t<e;t++)h.push(new Int16Array(u));for(let a=0;a<e;a++){const{adpcmCoefficients:e}=o[a],i=l[a],d=[];if(2===n){const n=i[0],{yn1:o,yn2:l}=r[a][t];let h=n,c=o,p=l,f=0;for(let t=0;t<u;){let s=0;t%14==0&&(h=i[f++]),s=0==(1&t++)?i[f]>>4:15&i[f++],s>=8&&(s-=16);const a=h>>4<<1;s=1024+((1<<(15&h))*s<<11)+e[$(a,0,15)]*c+e[$(a+1,0,15)]*p>>11,p=c,c=$(s,-32768,32767),d.push(c)}t<s-1&&(r[a][t+1].yn1=d[u-1],r[a][t+1].yn2=d[u-2])}else if(1===n)for(let t=0;t<u;t++){const e=Y(X(i,2*t,2,this.endianness));d.push(e)}else{if(0!==n)throw new Error("Invalid codec");for(let t=0;t<u;t++)d.push(256*Y(i[t]))}h[a].set(d)}return I(this,nt)[t]=h,h};var yt=function(t,e,s,a){return new(s||(s=Promise))((function(i,n){function o(t){try{r(a.next(t))}catch(t){n(t)}}function l(t){try{r(a.throw(t))}catch(t){n(t)}}function r(t){var e;t.done?i(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(o,l)}r((a=a.apply(t,e||[])).next())}))};function vt(t,e,s){let a=[],i=0;for(let e=0;e<t.metadata.numberChannels;e++)a.push(new Int16Array(s));for(;i<s;){let n=t.getSamples(e+i,Math.min(t.metadata.samplesPerBlock,s-i));for(let t=0;t<n.length;t++)a[t].set(n[t],i);i+=Math.min(t.metadata.samplesPerBlock,s-i)}return a}let _t=new class{constructor(t="https://smashcustommusic.net"){this._state={hasInitialized:!1,capabilities:null,audioContext:null,scriptNode:null,gainNode:null,fullyLoaded:!0,loadState:0,playbackCurrentSample:0,brstm:null,brstmBuffer:null,paused:!1,stopped:!1,enableLoop:!1,streamCancel:!1,playAudioRunning:!1,volume:Number(localStorage.getItem("volumeoverride"))||1,samplesReady:0},this._apiURL=t,this._audio=document.createElement("audio"),this._audio.id=o,this._audio.src="https://github.com/anars/blank-audio/blob/master/5-seconds-of-silence.mp3?raw=true",this._audio.loop=!0,document.body.appendChild(this._audio)}getBrstmUrl(t){return this._apiURL+"/brstm/"+t}getSongUrl(t){return this._apiURL+"/json/song/"+t}sendEvent(t,e={}){this._audio.dispatchEvent(new CustomEvent(t,{detail:e}))}sendUpdateStateEvent(){this.sendEvent(l.step,{position:this._state.playbackCurrentSample,paused:this._state.paused,volume:this._state.volume,loaded:this._state.samplesReady,looping:this._state.enableLoop})}getResampledSample(t,e,s){return Math.ceil(s/t*e)}loadSongLegacy(t){return yt(this,void 0,void 0,(function*(){let e=yield fetch(t),s=yield e.arrayBuffer();this._state.brstm=new gt(s),this._state.fullyLoaded=!0,this._state.loadState=Number.MAX_SAFE_INTEGER,this._state.samplesReady=Number.MAX_SAFE_INTEGER}))}loadSongStreaming(t){return new Promise(((e,s)=>yt(this,void 0,void 0,(function*(){let a,i;this.sendEvent(l.loading);try{a=yield fetch(t),i=(yield a.body).getReader()}catch(t){return s(t)}this._state.brstmBuffer=new ArrayBuffer(parseInt(a.headers.get("content-length")));let o=new Uint8Array(this._state.brstmBuffer),r=0,h=!1,u=0;for(this._state.samplesReady=0,this._state.fullyLoaded=!1,this._state.streamCancel=!1;;){let t;try{t=yield i.read()}catch(t){return void(h?(this.sendEvent(l.killed,{streamingDied:!0,buffering:!1,ready:!0}),yield this._state.audioContext.close(),this._state.audioContext=null):s(t))}if(this._state.streamCancel)return yield i.cancel(),void window.postMessage("continueload");if(t.done){if(!h)try{this._state.brstm=new gt(this._state.brstmBuffer),e(),h=!0}catch(t){return void s(t)}this._state.fullyLoaded=!0,this._state.samplesReady=Number.MAX_SAFE_INTEGER,console.log("File finished streaming");break}if(o.set(t.value,r),r+=t.value.length,this._state.loadState=r,0==u&&r>128){let t=0;65279==256*o[4]+o[5]&&(t=1),u=1==t?16777216*o[112]+65536*o[113]+256*o[114]+o[115]:o[112]+256*o[113]+65536*o[114]+16777216*o[115],u<144&&(u=n)}if(!h&&0!=u&&r>u)try{this._state.brstm=new gt(this._state.brstmBuffer),e(),h=!0}catch(t){return void s(t)}h&&(this._state.samplesReady=Math.floor((this._state.loadState-u)/this._state.brstm.metadata.numberChannels/this._state.brstm.metadata.blockSize)*this._state.brstm.metadata.samplesPerBlock)}}))))}setVolume(t){this._state.volume=t,this.sendEvent(l.setVolume,{volume:t}),this.sendUpdateStateEvent(),this._state.gainNode&&this._state.gainNode.gain.setValueAtTime(this._state.volume,this._state.audioContext.currentTime)}incVolume(t){this.setVolume(Math.min(this._state.volume+t,1))}decVolume(t){this.setVolume(Math.max(this._state.volume-t,0))}seek(t){this._state.playbackCurrentSample=Math.floor(t),this.sendEvent(l.seek,{toSample:this._state.playbackCurrentSample}),this.sendUpdateStateEvent()}next(){this.sendEvent(l.next)}previous(){this.sendEvent(l.previous)}playPause(){this._state.paused=!this._state.paused,this._state.audioContext[this._state.paused?"suspend":"resume"](),this._state.capabilities.mediaSession&&(navigator.mediaSession.playbackState="playing"===navigator.mediaSession.playbackState?"paused":"playing"),this.sendEvent(l.playPause,{playing:"playing"===navigator.mediaSession.playbackState}),this.sendUpdateStateEvent()}setLoop(t){this._state.enableLoop=t,this.sendEvent(l.setLoop,{loop:t}),this.sendUpdateStateEvent()}stop(){this._state.stopped=!0,this.sendEvent(l.stop)}fetchSongDetails(t){return yt(this,void 0,void 0,(function*(){let e=yield fetch(this.getSongUrl(t));e.status>=400?console.error(`could not fetch song details for id ${t}.`):this._song=yield e.json()}))}play(t){return yt(this,void 0,void 0,(function*(){let e=this.getBrstmUrl(t);if(this.sendEvent(l.play,{id:t,url:e}),this._state.capabilities=yield function(){return F(this,void 0,void 0,(function*(){let t={sampleRate:!1,streaming:!1,mediaSession:!1};try{let e=new(window.AudioContext||AudioContext)({sampleRate:8e3});t.sampleRate=8e3===e.sampleRate,e.close()}catch(t){console.log("WebAudio sample rate capability detection failed. Assuming fallback.")}try{let e=new Uint8Array(Math.pow(2,16)),s=new Blob([e],{type:"application/octet-stream"}),a=URL.createObjectURL(s),i=yield fetch(a);const n=(yield i.body).getReader();for(;!(yield n.read()).done;);t.streaming=!0}catch(t){console.log("Streaming capability detection failed. Assuming fallback.")}t.mediaSession="mediaSession"in navigator;var e=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./),s=!!e&&parseInt(e[2],10);return!1!==s&&s>=89&&(t.sampleRate=!1),t}))}(),this.fetchSongDetails(t).then((t=>{this._setMediaSessionData(),this._state.capabilities.mediaSession&&(navigator.mediaSession.playbackState="playing")})),this._state.stopped=!1,console.log(`Playing ${e}`),this._state.hasInitialized||this.sendEvent(l.start,{loaded:this._state.samplesReady}),this._state.playAudioRunning)return;var s,a;this._state.playAudioRunning=!0,this._state.fullyLoaded||(console.log("Cancelling last stream..."),this._state.streamCancel=!0,yield(s="continueload",new Promise((t=>{let e=a=>{a.data===s&&a.isTrusted&&(window.removeEventListener("message",e),t())};window.addEventListener("message",e)}))),console.log("Done.")),this._state.audioContext&&(yield this._state.audioContext.close(),this._state.audioContext=null),this._state.playbackCurrentSample=0,this._state.paused=!1,this.sendEvent(l.resetState,{ready:!1,position:0,samples:1e6,loaded:0,volume:this._state.volume,paused:!1,buffering:!1,sampleRate:44100,streamingDied:!1});try{yield(this._state.capabilities.streaming?this.loadSongStreaming.bind(this):this.loadSongLegacy.bind(this))(e)}catch(t){return this.sendEvent(l.killed,{streamingDied:!0,buffering:!1,ready:!0}),console.error(t),void(this._state.playAudioRunning=!1)}this._state.audioContext=new window.AudioContext(this._state.capabilities.sampleRate?{sampleRate:this._state.brstm.metadata.sampleRate}:{}),this._state.enableLoop=1===this._state.brstm.metadata.loopFlag,yield function(t){return new Promise((e=>z(this,void 0,void 0,(function*(){let s=!1,a=document.createElement("div");a.setAttribute("style","background: #888a; z-index: 88888; position: fixed; top: 0; bottom: 0; left: 0; right: 0; display: flex; align-items: center; justify-content: center;");let i=document.createElement("div");i.setAttribute("style","display: flex; align-items: center; justify-content: center; flex-direction: column"),i.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" version="1.0"  width="200" height="200" viewBox="0 0 75 75">\n<path d="M39.389,13.769 L22.235,28.606 L6,28.606 L6,47.699 L21.989,47.699 L39.389,62.75 L39.389,13.769z"\nstyle="stroke:#fff;stroke-width:5;stroke-linejoin:round;fill:#fff;"\n/>\n<path d="M48,27.6a19.5,19.5 0 0 1 0,21.4M55.1,20.5a30,30 0 0 1 0,35.6M61.6,14a38.8,38.8 0 0 1 0,48.6" style="fill:none;stroke:#fff;stroke-width:5;stroke-linecap:round"/>\n</svg><h1 style="font-family: sans-serif; color: white; margin: 0;">Tap or click anywhere to enable audio.</h1>',a.appendChild(i),setTimeout((function(){s||document.body.appendChild(a)}),200),t.onstatechange=function(){"running"==t.state&&(e(),a.remove(),s=!0)};try{t.resume()}catch(t){console.error(t)}a.addEventListener("touchend",(function(){return z(this,void 0,void 0,(function*(){yield t.resume(),"running"===t.state&&(e(),a.remove(),s=!0)}))})),a.addEventListener("click",(function(){return z(this,void 0,void 0,(function*(){yield t.resume(),"running"===t.state&&(e(),a.remove(),s=!0)}))})),"running"===t.state&&(e(),a.remove(),s=!0)}))))}(this._state.audioContext),this._state.capabilities.streaming&&(yield(a=1e3,new Promise((t=>setTimeout(t,a))))),this._state.scriptNode=this._state.audioContext.createScriptProcessor(0,0,2);let i=this._state.scriptNode.bufferSize;i=this._state.capabilities.sampleRate?i:this.getResampledSample(this._state.audioContext.sampleRate,this._state.brstm.metadata.sampleRate,i);let n=i;this._state.capabilities.sampleRate||(n+=20),this.sendEvent(l.loaded,{ready:!0,samples:this._state.brstm.metadata.totalSamples,sampleRate:this._state.brstm.metadata.sampleRate}),this._state.playAudioRunning=!1,this._state.scriptNode.onaudioprocess=t=>{if(!0===this._state.stopped)return;this.sendUpdateStateEvent();let e,s=t.outputBuffer;if(s.copyToChannel||(s.copyToChannel=O),this._state.playbackCurrentSample+i+1024>this._state.samplesReady)return this.sendEvent(l.buffering,{buffering:!0}),console.log("Buffering...."),s.copyToChannel(new Float32Array(this._state.scriptNode.bufferSize).fill(0),0),void s.copyToChannel(new Float32Array(this._state.scriptNode.bufferSize).fill(0),1);if(this.sendEvent(l.buffering,{buffering:!1}),this._state.paused)return s.copyToChannel(new Float32Array(this._state.scriptNode.bufferSize).fill(0),0),void s.copyToChannel(new Float32Array(this._state.scriptNode.bufferSize).fill(0),1);if(this._state.playbackCurrentSample+n<this._state.brstm.metadata.totalSamples)e=vt(this._state.brstm,this._state.playbackCurrentSample,n),this._state.playbackCurrentSample+=i;else if(this._state.enableLoop){e=vt(this._state.brstm,this._state.playbackCurrentSample,this._state.brstm.metadata.totalSamples-this._state.playbackCurrentSample);let t=e[0].length;console.log(this._state.brstm.metadata.totalSamples-this._state.playbackCurrentSample,n-t);let s=vt(this._state.brstm,this._state.brstm.metadata.loopStartSample,n-t);for(let t=0;t<e.length;t++){let a=new Int16Array(n).fill(0);a.set(e[t]),a.set(s[t],e[t].length),e[t]=a}this._state.playbackCurrentSample=this._state.brstm.metadata.loopStartSample+i-t}else{e=vt(this._state.brstm,this._state.playbackCurrentSample,this._state.brstm.metadata.totalSamples-this._state.playbackCurrentSample-1);for(let t=0;t<e.length;t++){let s=new Int16Array(n).fill(0);s.set(e[t]),e[t]=s}this._state.playbackCurrentSample=0,this._state.paused=!0,setTimeout((()=>{this._state.audioContext.suspend()}),200)}e.length>2&&(e=[e[0],e[1]]),1===e.length&&(e=[e[0],e[0]]);for(let t=0;t<e.length;t++){let a=new Float32Array(n);for(let s=0;s<n;s++)a[s]=e[t][s]/32768;if(!this._state.capabilities.sampleRate){let t=new W(this._state.brstm.metadata.sampleRate,this._state.audioContext.sampleRate,1,a);t.resampler(n),a=new Float32Array(t.outputBuffer),a.length>this._state.scriptNode.bufferSize&&(a=a.slice(0,this._state.scriptNode.bufferSize))}s.copyToChannel(a,t)}},this._state.gainNode=this._state.audioContext.createGain(),this._state.scriptNode.connect(this._state.gainNode),this._state.gainNode.connect(this._state.audioContext.destination),this._state.gainNode.gain.setValueAtTime(this._state.volume,this._state.audioContext.currentTime)}))}_setMediaSessionData(){return yt(this,void 0,void 0,(function*(){this._state.capabilities.mediaSession&&this._audio.play().then((t=>{navigator.mediaSession.metadata=new MediaMetadata({title:this._song.name,album:this._song.game_name,artist:this._song.uploader,artwork:[{src:"https://ssb.wiki.gallery/images/a/a2/SSBU_spirit_Smash_Ball.png",type:"image/png",sizes:"560x544"}]}),navigator.mediaSession.setActionHandler("play",(()=>{this.playPause()})),navigator.mediaSession.setActionHandler("pause",(()=>{this.playPause()})),navigator.mediaSession.setActionHandler("stop",(()=>{this.stop()})),navigator.mediaSession.setActionHandler("nexttrack",(()=>this.next)),navigator.mediaSession.setActionHandler("previoustrack",(()=>this.previous))})).catch((t=>{console.error(t)}))}))}}("https://smashcustommusic.net");P.runGUI(_t),window.player=_t}();
