!function(){"use strict";class t{constructor(){this.registerOpEvent=function(t,e){if(this.operationListeners.has(t)){let s=this.operationListeners.get(t);s.push(e),this.operationListeners.set(t,s)}else this.operationListeners.set(t,[e])},this.registerFinEvent=function(t,e){if(this.finishedListeners.has(t)){let s=this.finishedListeners.get(t);s.push(e),this.finishedListeners.set(t,s)}else this.finishedListeners.set(t,[e])},this.currentlyGesturing=!1,this.activeArea="",this.activeAreaElem=null,this.operationListeners=new Map,this.finishedListeners=new Map}sanitize(t,e){let s=this.activeAreaElem.getBoundingClientRect(),i=t-s.x,a=e-s.y;return i<0&&(i=0),a<0&&(a=0),i>s.width&&(i=s.width),a>s.height&&(a=s.height),[i,a]}fireOp(t,e,s){if(this.operationListeners.has(t))for(let i=0;i<this.operationListeners.get(t).length;i++)this.operationListeners.get(t)[i](e,s)}fireFin(t,e,s){if(this.finishedListeners.has(t))for(let i=0;i<this.finishedListeners.get(t).length;i++)this.finishedListeners.get(t)[i](e,s)}runGestureEngine(){s()}}let e=new t;function s(){document.addEventListener("mousedown",(function(t){if(t.target.dataset.gestureHitzone){e.currentlyGesturing=!0,e.activeArea=t.target.dataset.gestureHitzone,e.activeAreaElem=t.target;let[s,i]=e.sanitize(t.clientX,t.clientY);e.fireOp(e.activeArea,s,i)}})),document.addEventListener("mousemove",(function(t){if(e.currentlyGesturing){let[s,i]=e.sanitize(t.clientX,t.clientY);e.fireOp(e.activeArea,s,i)}})),document.addEventListener("mouseup",(function(t){if(e.currentlyGesturing){let[s,i]=e.sanitize(t.clientX,t.clientY);e.fireFin(e.activeArea,s,i),e.currentlyGesturing=!1,e.activeAreaElem=null,e.activeArea=""}}))}function i(t){if(t.__esModule)return t;var e=Object.defineProperty({},"__esModule",{value:!0});return Object.keys(t).forEach((function(s){var i=Object.getOwnPropertyDescriptor(t,s);Object.defineProperty(e,s,i.get?i:{enumerable:!0,get:function(){return t[s]}})})),e}var a=i(Object.freeze({__proto__:null,getInstance:function(){return null==e&&(e=new t),e},runGestureEngine:s}));const n=Math.pow(2,19),l="brstm_player";var o;!function(t){t.start="brstm_start",t.play="brstm_play",t.pause="brstm_pause",t.playPause="brstm_playpause",t.stop="brstm_stop",t.next="brstm_next",t.previous="brstm_previous",t.seek="brstm_seek",t.setLoop="brstm_setloop",t.setVolume="brstm_setvolume",t.buffering="brstm_buffering",t.loading="brstm_loading",t.loaded="brstm_loaded",t.killed="brstm_killed",t.step="brstm_step",t.resetState="brstm_resetstate",t.playlistAdd="brstm_playlist_add",t.playlistRemove="brstm_playlist_remove"}(o||(o={}));const r=a.getInstance();let h={display:!1,position:0,samples:1e6,loaded:5e5,volume:1,paused:!1,ready:!1,buffering:!1,sampleRate:48e3,looping:!1,streamingDied:!1},u={volume:null,position:null},d={},p=null,c=null,f=null,m=-30;function g(t){try{t.preventDefault()}catch(t){}if(t.targetTouches.length>0){let e=t.targetTouches[0].target.getBoundingClientRect(),s=t.targetTouches[0].clientY+t.targetTouches[0].radiusY-e.top;s<5&&(s=0),s>80&&(s=84);let i=1-s/84;u.volume=i,"touchend"===t.type&&(h.volume=u.volume,d.setVolume(u.volume),u.volume=null,localStorage.setItem("volumeoverride",i)),P()}else"touchend"===t.type&&(h.volume=u.volume,d.setVolume(u.volume),u.volume=null)}function y(t){try{t.preventDefault()}catch(t){}if(t.targetTouches.length>0){let e=t.targetTouches[0].target.getBoundingClientRect(),s=t.targetTouches[0].clientX+t.targetTouches[0].radiusX-e.left;if(s<5&&(s=0),s>254&&(s=254),s=Math.round(s),s===m)return;m=s;let i=h.samples*(s/254);i<h.loaded&&(u.position=i),"touchend"===t.type&&(d.seek(u.position),u.position=null),P()}else"touchend"===t.type&&(d.seek(u.position),u.position=null)}function v(t,e){let s=Math.round(t),i=h.samples*(s/254);i<h.loaded&&(u.position=i),P()}function _(t,e){let s=Math.round(t),i=h.samples*(s/254);i<h.loaded&&(u.position=i),d.seek(i),u.position=null,P()}function b(t,e){e=Math.round(e),u.volume=1-e/84,P()}function w(t,e){let s=1-(e=Math.round(e))/84;u.volume=null,localStorage.setItem("volumeoverride",s),d.setVolume(s),P()}let S=null,k=null,E=-1,L=-1,R=null,x=-1,C=-1,M=null,B=-1,A=null;function D(){f&&(h.display=!1,f.style.display="none")}function P(){if(h.display&&(f.style.display="block"),f){A!==h.streamingDied&&(f.querySelector(".error").style.display=h.streamingDied?"flex":"none",A=h.streamingDied);let t=h.buffering||!h.ready;if(S!==t&&(f.querySelector("#gui-loading-bar").dataset.exists=t,S=t),k!==h.ready&&(f.querySelector('.guistate[data-guistate="preload"]').style.display=h.ready?"none":"block",f.querySelector('.guistate[data-guistate="ready"]').style.display=h.ready?"grid":"none",k=h.ready),!h.ready)return;let e=Math.round(84-84*h.volume);null!==u.volume&&(e=Math.round(84-84*u.volume)),e!==E&&(p.fillStyle="#444",p.fillRect(0,0,16,84),p.fillStyle="hsl(200, 85%, 55%)",p.fillRect(0,e,16,84),E=e);let s=Math.ceil(h.position/h.samples*254);null!==u.position&&(s=Math.ceil(u.position/h.samples*254));let i=Math.ceil(h.loaded/h.samples*254);s===L&&i===B||(c.fillStyle="#222",c.fillRect(0,0,254,16),c.fillStyle="#666",c.fillRect(0,0,Math.min(254,i),16),c.fillStyle="hsl(200, 85%, 55%)",c.fillRect(0,0,Math.min(254,s),16),L=s,B=i),R!==h.paused&&(f.querySelector("#pl-pause").style.display=h.paused?"none":"block",f.querySelector("#pl-play").style.display=h.paused?"block":"none",R=h.paused);let a=Math.floor(h.samples/h.sampleRate),n=Math.floor(h.position/h.sampleRate);null!==u.position&&(n=Math.floor(u.position/h.sampleRate)),a!==x&&(f.querySelector("#pl-time-end").innerText=`${Math.floor(a/60)}:${(a%60).toString().padStart(2,"0")}`,x=a),n!==C&&(f.querySelector("#pl-time-start").innerText=`${Math.floor(n/60)}:${(n%60).toString().padStart(2,"0")}`,C=n),M!==h.looping&&(f.querySelector("#pl-loop-box").checked=h.looping,M=h.looping)}}var T=Object.freeze({__proto__:null,runGUI:function(t){!function(){let t=document.getElementById(l);t&&(t.addEventListener(o.step,(t=>{h=Object.assign(Object.assign({},h),{position:t.detail.position,paused:t.detail.paused,volume:t.detail.volume,loaded:t.detail.loaded,looping:t.detail.looping}),P()})),t.addEventListener(o.killed,(t=>{h=Object.assign(Object.assign({},h),{streamingDied:t.detail.streamingDied,buffering:t.detail.buffering,ready:t.detail.ready}),D()})),t.addEventListener(o.setVolume,(t=>{h.volume=t.detail.volume,P()})),t.addEventListener(o.seek,(t=>{h.position=t.detail.toSample,P()})),t.addEventListener(o.playPause,(t=>{h.paused=t.detail.playing,P()})),t.addEventListener(o.setLoop,(t=>{h.looping=t.detail.loop,P()})),t.addEventListener(o.stop,(t=>{D()})),t.addEventListener(o.start,(t=>{h.loaded=t.detail.loaded,h.display=!0,P()})),t.addEventListener(o.resetState,(t=>{h=Object.assign(Object.assign({},h),{ready:t.detail.ready,position:t.detail.position,samples:t.detail.samples,loaded:t.detail.loaded,volume:t.detail.volume,paused:t.detail.paused,buffering:t.detail.buffering,sampleRate:t.detail.sampleRate,streamingDied:t.detail.streamingDied}),P()})),t.addEventListener(o.loaded,(t=>{h=Object.assign(Object.assign({},h),{ready:t.detail.ready,samples:t.detail.samples,sampleRate:t.detail.sampleRate}),P()})),t.addEventListener(o.buffering,(t=>{h.buffering=t.detail.buffering,P()})))}(),d=t,f=document.createElement("div"),f.style.display="none",f.classList.add("guiholder"),f.innerHTML='\n<div class="error" style="display: none">\n    <h3>Playback failed!</h3>\n    <h3>Reload the page and try again.</h3>\n    <h3>If the issue continues, contact us.</h3>\n</div>\n<div id="gui-loading-bar">\n    <div id="gui-inner-loading-bar"></div>\n</div>\n<div class="guistate" data-guistate="preload">\n    <h3>Loading song...</h3>\n</div>\n<div class="guistate" data-guistate="ready">\n    <div id="pl-pause-play">\n        <svg width="48" height="48" viewBox="0 0 48 48" id="pl-play">\n            <path d="M 10, 10 l 0, 28 l 28, -14" fill="white"></path>\n        </svg>\n        <svg width="48" height="48" viewBox="0 0 48 48" id="pl-pause" style="display: none;">\n            <path d="M 10, 10 l 0, 28 l 10, 0 l 0, -28 M 28, 10 l 0, 28 l 10, 0 l 0, -28" fill="white"></path>\n        </svg>\n    </div>\n    <canvas id="pl-volume" width="16" height="84" data-gesture-hitzone="volume"></canvas>\n    <div id="pl-timing">\n        <span id="pl-time-start">0:00</span>\n        <span id="pl-time-end"  >0:00</span>\n    </div>\n    <canvas id="pl-seek" width="254" height="16" data-gesture-hitzone="seek"></canvas>\n    <div id="pl-loop">\n        <input type="checkbox" id="pl-loop-box" style="width: 16px; height: 16px; margin: 0;">\n        <span class="pl-loop-text">Enable loop</span>\n        <a class="pl-loop-text" target="_blank" href="https://smashcustommusic.net/feedback/">Send feedback</a>\n        <a class="pl-loop-text" target="_blank" href="https://github.com/rphsoftware/revolving-door">v2 by Rph</a>\n    </div>\n</div>',document.body.appendChild(f),p=document.querySelector("#pl-volume").getContext("2d"),c=document.querySelector("#pl-seek").getContext("2d"),document.querySelector("#pl-volume").addEventListener("touchstart",g),document.querySelector("#pl-volume").addEventListener("touchmove",g),document.querySelector("#pl-volume").addEventListener("touchend",g),document.querySelector("#pl-seek").addEventListener("touchstart",y),document.querySelector("#pl-seek").addEventListener("touchmove",y),document.querySelector("#pl-seek").addEventListener("touchend",y),document.querySelector("#pl-pause-play").addEventListener("click",(function(){d.playPause(),P()})),document.querySelector("#pl-loop-box").addEventListener("input",(function(){h.looping=document.querySelector("#pl-loop-box").checked,d.setLoop(h.looping)})),f.addEventListener("drag",(function(t){t.preventDefault()})),r.runGestureEngine(),r.registerOpEvent("seek",v),r.registerFinEvent("seek",_),r.registerOpEvent("volume",b),r.registerFinEvent("volume",w)}}),O=i(T);function W(t,e){let s=this.getChannelData(e);for(let e=0;e<t.length;e++)s[e]=t[e]}class I{constructor(t,e,s,i){if(this._fromSampleRate=t,this._toSampleRate=e,this._channels=0|s,"object"!=typeof i)throw new Error("inputBuffer is not an object.");if(!(i instanceof Array||i instanceof Float32Array||i instanceof Float64Array))throw new Error("inputBuffer is not an array or a float32 or a float64 array.");this._inputBuffer=i,this.initialize()}initialize(){if(!(this._fromSampleRate>0&&this._toSampleRate>0&&this._channels>0))throw new Error("Invalid settings specified for the resampler.");this._fromSampleRate==this._toSampleRate?(this._resampler=this.bypassResampler,this._ratioWeight=1,this._outputBuffer=this._inputBuffer):(this._ratioWeight=this._fromSampleRate/this._toSampleRate,this._fromSampleRate<this._toSampleRate?(this.compileLinearInterpolationFunction(),this._lastWeight=1):(this.compileMultiTapFunction(),this.tailExists=!1,this._lastWeight=0),this.initializeBuffers())}initializeBuffers(){var t=Math.ceil(this._inputBuffer.length*this._toSampleRate/this._fromSampleRate/this._channels*1.0000004768371582)*this._channels+this._channels;try{this._outputBuffer=new Float32Array(t),this._lastOutput=new Float32Array(this._channels)}catch(t){this._outputBuffer=new Float32Array([]),this._lastOutput=new Float32Array([])}}bypassResampler(t){return t}compileMultiTapFunction(){for(var t="var outputOffset = 0;    if (bufferLength > 0) {        var buffer = this._inputBuffer;        var weight = 0;",e=0;e<this._channels;++e)t+="var output"+e+" = 0;";for(t+="var actualPosition = 0;        var amountToNext = 0;        var alreadyProcessedTail = !this.tailExists;        this._tailExists = false;        var outputBuffer = this._outputBuffer;        var currentPosition = 0;        do {            if (alreadyProcessedTail) {                weight = "+this._ratioWeight+";",e=0;e<this._channels;++e)t+="output"+e+" = 0;";for(t+="}            else {                weight = this._lastWeight;",e=0;e<this._channels;++e)t+="output"+e+" = this._lastOutput["+e+"];";for(t+="alreadyProcessedTail = true;            }            while (weight > 0 && actualPosition < bufferLength) {                amountToNext = 1 + actualPosition - currentPosition;                if (weight >= amountToNext) {",e=0;e<this._channels;++e)t+="output"+e+" += buffer[actualPosition++] * amountToNext;";for(t+="currentPosition = actualPosition;                    weight -= amountToNext;                }                else {",e=0;e<this._channels;++e)t+="output"+e+" += buffer[actualPosition"+(e>0?" + "+e:"")+"] * weight;";for(t+="currentPosition += weight;                    weight = 0;                    break;                }            }            if (weight <= 0) {",e=0;e<this._channels;++e)t+="outputBuffer[outputOffset++] = output"+e+" / "+this._ratioWeight+";";for(t+="}            else {                this._lastWeight = weight;",e=0;e<this._channels;++e)t+="this._lastOutput["+e+"] = output"+e+";";t+="this._tailExists = true;                break;            }        } while (actualPosition < bufferLength);    }    return outputOffset;",this._resampler=Function("bufferLength",t)}compileLinearInterpolationFunction(){for(var t="var outputOffset = 0;    if (bufferLength > 0) {        var buffer = this._inputBuffer;        var weight = this._lastWeight;        var firstWeight = 0;        var secondWeight = 0;        var sourceOffset = 0;        var outputOffset = 0;        var outputBuffer = this._outputBuffer;        for (; weight < 1; weight += "+this._ratioWeight+") {            secondWeight = weight % 1;            firstWeight = 1 - secondWeight;",e=0;e<this._channels;++e)t+="outputBuffer[outputOffset++] = (this._lastOutput["+e+"] * firstWeight) + (buffer["+e+"] * secondWeight);";t+="}        weight -= 1;        for (bufferLength -= "+this._channels+", sourceOffset = Math.floor(weight) * "+this._channels+"; sourceOffset < bufferLength;) {            secondWeight = weight % 1;            firstWeight = 1 - secondWeight;";for(e=0;e<this._channels;++e)t+="outputBuffer[outputOffset++] = (buffer[sourceOffset"+(e>0?" + "+e:"")+"] * firstWeight) + (buffer[sourceOffset + "+(this._channels+e)+"] * secondWeight);";t+="weight += "+this._ratioWeight+";            sourceOffset = Math.floor(weight) * "+this._channels+";        }";for(e=0;e<this._channels;++e)t+="this._lastOutput["+e+"] = buffer[sourceOffset++];";t+="this._lastWeight = weight % 1;    }    return outputOffset;",this._resampler=Function("bufferLength",t)}get outputBuffer(){return this._outputBuffer}get resampler(){return this._resampler}}var z=function(t,e,s,i){return new(s||(s=Promise))((function(a,n){function l(t){try{r(i.next(t))}catch(t){n(t)}}function o(t){try{r(i.throw(t))}catch(t){n(t)}}function r(t){var e;t.done?a(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(l,o)}r((i=i.apply(t,e||[])).next())}))};var F=function(t,e,s,i){return new(s||(s=Promise))((function(a,n){function l(t){try{r(i.next(t))}catch(t){n(t)}}function o(t){try{r(i.throw(t))}catch(t){n(t)}}function r(t){var e;t.done?a(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(l,o)}r((i=i.apply(t,e||[])).next())}))};var N=(t,e,s)=>{if(!e.has(t))throw TypeError("Cannot "+s)},j=(t,e,s)=>(N(t,e,"read from private field"),s?s.call(t):e.get(t)),q=(t,e,s)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,s)},U=(t,e,s,i)=>(N(t,e,"write to private field"),i?i.call(t,s):e.set(t,s),s),G=(t,e,s)=>(N(t,e,"access private method"),s);function V(t,e,s){const i=[];for(let a=e;a<e+s;a++)i.push(t[a]);return i}const H=0,X=1;function $(t,e,s,i=X){const a=V(t,e,s);return i===H&&a.reverse(),a.reduce(((t,e)=>256*t+e),0)}function Y(t,e,s){return t<=e?e:t>=s?s:t}function J(t){return t>=32768?t-65536:t}var K,Q,Z,tt,et,st,it,at,nt,lt,ot,rt,ht,ut,dt,pt,ct,ft,mt,gt;class yt{constructor(t){if(q(this,ot),q(this,ht),q(this,dt),q(this,ct),q(this,mt),q(this,K,void 0),q(this,Q,void 0),q(this,Z,void 0),q(this,tt,void 0),q(this,et,void 0),q(this,st,void 0),q(this,it,void 0),q(this,at,void 0),q(this,nt,void 0),q(this,lt,void 0),U(this,it,null),U(this,at,null),U(this,nt,null),U(this,lt,[]),this.rawData=new Uint8Array(t),"RSTM"!==function(t,e,s,i=X){const a=V(t,e,s);return i===H&&a.reverse(),String.fromCharCode(...a)}(this.rawData,0,4))throw new Error("Not a valid BRSTM file");this.endianness=function(t){const e=V(t,4,2);return 255===e[0]&&254===e[1]?H:X}(this.rawData),U(this,K,$(this.rawData,16,4,this.endianness)),U(this,Q,j(this,K)+$(this.rawData,j(this,K)+12,4,this.endianness)+8),U(this,Z,j(this,K)+$(this.rawData,j(this,K)+20,4,this.endianness)+8),U(this,tt,j(this,K)+$(this.rawData,j(this,K)+28,4,this.endianness)+8),U(this,et,$(this.rawData,24,4,this.endianness)),U(this,st,$(this.rawData,32,4,this.endianness)),this.metadata=G(this,ht,ut).call(this)}getAllSamples(){if(j(this,it))return j(this,it);const{numberChannels:t,totalSamples:e,totalBlocks:s,samplesPerBlock:i}=this.metadata,a=[];for(let s=0;s<t;s++)a.push(new Int16Array(e));for(let e=0;e<s;e++){const s=G(this,mt,gt).call(this,e);for(let n=0;n<t;n++)a[n].set(s[n],e*i)}return U(this,it,a),a}getBuffer(t,e){return this.getSamples(t,e)}getSamples(t,e){const{numberChannels:s,totalBlocks:i,totalSamples:a,samplesPerBlock:n}=this.metadata,l=Math.max(0,t),o=Math.min(a,t+e),r=Math.max(0,Math.floor(l/n)),h=Math.min(i-1,Math.floor(o/n)),u=[];for(let t=r;t<=h;t++)u.push(G(this,mt,gt).call(this,t));const d=[];for(let t=0;t<s;t++)d.push(new Int16Array(o-l));for(let t=r;t<=h;t++){const i=t-r;if(t===r&&t===h)for(let t=0;t<s;t++)d[t].set(u[i][t].slice(l-r*n,l-r*n+e),0);else if(t===r)for(let t=0;t<s;t++){const e=u[i][t].slice(l-r*n);d[t].set(e,0)}else if(t===h)for(let a=0;a<s;a++){const s=u[i][a].slice(0,o-u[i][a].length-r*n);s.length+(t*n-l)>d[a].length?d[a].set(s.slice(0,e-(t*n-l)),t*n-l):d[a].set(s,t*n-l)}else for(let e=0;e<s;e++)d[e].set(u[i][e],t*n-l)}return d}}K=new WeakMap,Q=new WeakMap,Z=new WeakMap,tt=new WeakMap,et=new WeakMap,st=new WeakMap,it=new WeakMap,at=new WeakMap,nt=new WeakMap,lt=new WeakMap,ot=new WeakSet,rt=function(){if(j(this,nt))return j(this,nt);const{numberChannels:t}=this.metadata,e=[];for(let s=0;s<t;s++){const t=j(this,K)+$(this.rawData,j(this,tt)+8+8*s,4,this.endianness)+8+8,i=[];for(let e=0;e<16;e++){const s=$(this.rawData,t+2*e,2,this.endianness);i.push(J(s))}e.push({adpcmCoefficients:i,gain:$(this.rawData,t+40,2,this.endianness),initialPredictorScale:$(this.rawData,t+42,2,this.endianness),historySample1:$(this.rawData,t+44,2,this.endianness),historySample2:$(this.rawData,t+46,2,this.endianness),loopPredictorScale:$(this.rawData,t+48,2,this.endianness),loopHistorySample1:$(this.rawData,t+50,2,this.endianness),loopHistorySample2:$(this.rawData,t+52,2,this.endianness)})}return U(this,nt,e),e},ht=new WeakSet,ut=function(){const t=$(this.rawData,j(this,Q)+2,1,this.endianness),e=$(this.rawData,j(this,Z),1,this.endianness),s=$(this.rawData,j(this,Z)+1,1,this.endianness),i=[];for(let t=0;t<e;t++){const e=j(this,K)+8+$(this.rawData,j(this,Z)+4+8*t+4,4,this.endianness),s=$(this.rawData,j(this,Z)+4+8*t+1,1,this.endianness);let a=0;0===s?a=$(this.rawData,e,1,this.endianness):1===s&&(a=$(this.rawData,e+8,1,this.endianness)),i.push({numberChannels:a,type:s})}const a={fileSize:$(this.rawData,8,4,this.endianness),endianness:this.endianness,codec:$(this.rawData,j(this,Q),1,this.endianness),loopFlag:$(this.rawData,j(this,Q)+1,1,this.endianness),numberChannels:t,sampleRate:$(this.rawData,j(this,Q)+4,2,this.endianness),loopStartSample:$(this.rawData,j(this,Q)+8,4,this.endianness),totalSamples:$(this.rawData,j(this,Q)+12,4,this.endianness),totalBlocks:$(this.rawData,j(this,Q)+20,4,this.endianness),blockSize:$(this.rawData,j(this,Q)+24,4,this.endianness),samplesPerBlock:$(this.rawData,j(this,Q)+28,4,this.endianness),finalBlockSize:$(this.rawData,j(this,Q)+32,4,this.endianness),finalBlockSizeWithPadding:$(this.rawData,j(this,Q)+40,4,this.endianness),totalSamplesInFinalBlock:$(this.rawData,j(this,Q)+36,4,this.endianness),adpcTableSamplesPerEntry:$(this.rawData,j(this,Q)+44,4,this.endianness),adpcTableBytesPerEntry:$(this.rawData,j(this,Q)+48,4,this.endianness),numberTracks:e,trackDescriptionType:s,trackDescriptions:i};return a.loopStartSample>=a.totalSamples&&(a.loopFlag=0,a.loopStartSample=0,console.warn("The loop start sample in this file is invalid.")),a},dt=new WeakSet,pt=function(t){const{blockSize:e,totalBlocks:s,numberChannels:i,finalBlockSize:a,finalBlockSizeWithPadding:n}=this.metadata,l=[];for(let n=0;n<i;n++)l.push(new Uint8Array(t===s-1?a:e));let o=t;for(let t=0;t<i;t++){const r=0!==t&&o+1===s?o*i*e+t*n:(o*i+t)*e,h=o+1===s?r+a:r+e,u=this.rawData.slice(j(this,st)+32+r,j(this,st)+32+h);l[t].set(u)}return l},ct=new WeakSet,ft=function(){if(j(this,at))return j(this,at);const{totalBlocks:t,numberChannels:e}=this.metadata,s=$(this.rawData,j(this,et)+4,4,this.endianness),i=this.rawData.slice(j(this,et)+8,j(this,et)+8+s);let a=0,n=0,l=0;for(let t=0;t<e;t++)n=J($(i,a,2,this.endianness)),a+=2,l=J($(i,a,2,this.endianness)),a+=2;const o=[];for(let s=0;s<t;s++){o.push([]);for(let t=0;t<e;t++)s>0&&(n=J($(i,a,2,this.endianness)),a+=2,l=J($(i,a,2,this.endianness)),a+=2),o[s].push({yn1:n,yn2:l})}let r=[];for(let t=0;t<e;t++)r.push(o.map((e=>e[t])));return U(this,at,r),r},mt=new WeakSet,gt=function(t){if(j(this,lt)[t])return j(this,lt)[t];const{numberChannels:e,totalBlocks:s,totalSamplesInFinalBlock:i,samplesPerBlock:a,codec:n}=this.metadata,l=G(this,ot,rt).call(this),o=G(this,dt,pt).call(this,t),r=G(this,ct,ft).call(this),h=[],u=t===s-1?i:a;for(let t=0;t<e;t++)h.push(new Int16Array(u));for(let i=0;i<e;i++){const{adpcmCoefficients:e}=l[i],a=o[i],d=[];if(2===n){const n=a[0],{yn1:l,yn2:o}=r[i][t];let h=n,p=l,c=o,f=0;for(let t=0;t<u;){let s=0;t%14==0&&(h=a[f++]),s=0==(1&t++)?a[f]>>4:15&a[f++],s>=8&&(s-=16);const i=h>>4<<1;s=1024+((1<<(15&h))*s<<11)+e[Y(i,0,15)]*p+e[Y(i+1,0,15)]*c>>11,c=p,p=Y(s,-32768,32767),d.push(p)}t<s-1&&(r[i][t+1].yn1=d[u-1],r[i][t+1].yn2=d[u-2])}else if(1===n)for(let t=0;t<u;t++){const e=J($(a,2*t,2,this.endianness));d.push(e)}else{if(0!==n)throw new Error("Invalid codec");for(let t=0;t<u;t++)d.push(256*J(a[t]))}h[i].set(d)}return j(this,lt)[t]=h,h};var vt=function(t,e,s,i){return new(s||(s=Promise))((function(a,n){function l(t){try{r(i.next(t))}catch(t){n(t)}}function o(t){try{r(i.throw(t))}catch(t){n(t)}}function r(t){var e;t.done?a(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(l,o)}r((i=i.apply(t,e||[])).next())}))};function _t(t,e,s){let i=[],a=0;for(let e=0;e<t.metadata.numberChannels;e++)i.push(new Int16Array(s));for(;a<s;){let n=t.getSamples(e+a,Math.min(t.metadata.samplesPerBlock,s-a));for(let t=0;t<n.length;t++)i[t].set(n[t],a);a+=Math.min(t.metadata.samplesPerBlock,s-a)}return i}let bt=new class{constructor(t="https://smashcustommusic.net"){this._playlist=[],this._idsInPlaylist=new Set,this._state={hasInitialized:!1,capabilities:null,audioContext:null,scriptNode:null,gainNode:null,fullyLoaded:!0,loadState:0,playbackCurrentSample:0,brstm:null,brstmBuffer:null,paused:!1,stopped:!1,enableLoop:!1,streamCancel:!1,playAudioRunning:!1,volume:Number(localStorage.getItem("volumeoverride"))||1,samplesReady:0},this._apiURL=t,this._audio=document.createElement("audio"),this._audio.id=l,this._audio.src="https://github.com/anars/blank-audio/blob/master/5-seconds-of-silence.mp3?raw=true",this._audio.loop=!0,document.body.appendChild(this._audio)}getBrstmUrl(t){return`${this._apiURL}/${t}`}sendEvent(t,e={}){this._audio.dispatchEvent(new CustomEvent(t,{detail:e,bubbles:!0}))}sendUpdateStateEvent(){this.sendEvent(o.step,{position:this._state.playbackCurrentSample,paused:this._state.paused,volume:this._state.volume,loaded:this._state.samplesReady,looping:this._state.enableLoop})}getResampledSample(t,e,s){return Math.ceil(s/t*e)}loadSongLegacy(t){return vt(this,void 0,void 0,(function*(){let e=yield fetch(t),s=yield e.arrayBuffer();this._state.brstm=new yt(s),this._state.fullyLoaded=!0,this._state.loadState=Number.MAX_SAFE_INTEGER,this._state.samplesReady=Number.MAX_SAFE_INTEGER}))}loadSongStreaming(t){return new Promise(((e,s)=>vt(this,void 0,void 0,(function*(){let i,a;this.sendEvent(o.loading);try{i=yield fetch(t),a=(yield i.body).getReader()}catch(t){return s(t)}this._state.brstmBuffer=new ArrayBuffer(parseInt(i.headers.get("content-length")));let l=new Uint8Array(this._state.brstmBuffer),r=0,h=!1,u=0;for(this._state.samplesReady=0,this._state.fullyLoaded=!1,this._state.streamCancel=!1;;){let t;try{t=yield a.read()}catch(t){return void(h?(this.sendEvent(o.killed,{streamingDied:!0,buffering:!1,ready:!0}),yield this._state.audioContext.close(),this._state.audioContext=null):s(t))}if(this._state.streamCancel)return yield a.cancel(),void window.postMessage("continueload");if(t.done){if(!h)try{this._state.brstm=new yt(this._state.brstmBuffer),e(),h=!0}catch(t){return void s(t)}this._state.fullyLoaded=!0,this._state.samplesReady=Number.MAX_SAFE_INTEGER,console.log("File finished streaming");break}if(l.set(t.value,r),r+=t.value.length,this._state.loadState=r,0==u&&r>128){let t=0;65279==256*l[4]+l[5]&&(t=1),u=1==t?16777216*l[112]+65536*l[113]+256*l[114]+l[115]:l[112]+256*l[113]+65536*l[114]+16777216*l[115],u<144&&(u=n)}if(!h&&0!=u&&r>u)try{this._state.brstm=new yt(this._state.brstmBuffer),e(),h=!0}catch(t){return void s(t)}h&&(this._state.samplesReady=Math.floor((this._state.loadState-u)/this._state.brstm.metadata.numberChannels/this._state.brstm.metadata.blockSize)*this._state.brstm.metadata.samplesPerBlock)}}))))}setVolume(t){this._state.volume=t,this.sendEvent(o.setVolume,{volume:t}),this.sendUpdateStateEvent(),this._state.gainNode&&this._state.gainNode.gain.setValueAtTime(this._state.volume,this._state.audioContext.currentTime)}incVolume(t){this.setVolume(Math.min(this._state.volume+t,1))}decVolume(t){this.setVolume(Math.max(this._state.volume-t,0))}seek(t){this._state.playbackCurrentSample=Math.floor(t),this.sendEvent(o.seek,{toSample:this._state.playbackCurrentSample}),this.sendUpdateStateEvent()}next(){this.movePlaylist(!0)}previous(){this.movePlaylist(!1)}movePlaylist(t=!0){if(0===this.playlist.length)return;let e=t?Math.min(this._currentIndex+1,this._playlist.length-1):Math.max(this._currentIndex-1,0);e!==this._currentIndex&&(this.sendEvent(o.previous),this._currentIndex=e,this.play(this.playlist[e]))}playPause(){this._state.paused=!this._state.paused,this._state.audioContext[this._state.paused?"suspend":"resume"](),this._state.capabilities.mediaSession&&(navigator.mediaSession.playbackState="playing"===navigator.mediaSession.playbackState?"paused":"playing"),this.sendEvent(o.playPause,{playing:"playing"===navigator.mediaSession.playbackState}),this.sendUpdateStateEvent()}setLoop(t){this._state.enableLoop=t,this.sendEvent(o.setLoop,{loop:t}),this.sendUpdateStateEvent()}stop(){this._state.stopped=!0,this.sendEvent(o.stop)}get currentSong(){return this._currentSong}get playlist(){return this._playlist}addToPlaylist(t){t&&(this._idsInPlaylist.has(t.id)||(this.sendEvent(o.playlistAdd,t),this._playlist.push(t),this._idsInPlaylist.add(t.id)))}removeFromPlaylist(t){this.sendEvent(o.playlistRemove,{songId:t}),this._playlist=this._playlist.filter((e=>e.id!==t))}clearPlaylist(){this._playlist=[]}init(t){return vt(this,void 0,void 0,(function*(){this.addToPlaylist(t),this._currentIndex=0,yield this.play(t)}))}play(t){return vt(this,void 0,void 0,(function*(){this._currentSong=t;let e=this.getBrstmUrl(t.id);if(this.sendEvent(o.play,Object.assign(Object.assign({},t),{url:e})),this._state.capabilities=yield function(){return F(this,void 0,void 0,(function*(){let t={sampleRate:!1,streaming:!1,mediaSession:!1};try{let e=new(window.AudioContext||AudioContext)({sampleRate:8e3});t.sampleRate=8e3===e.sampleRate,e.close()}catch(t){console.log("WebAudio sample rate capability detection failed. Assuming fallback.")}try{let e=new Uint8Array(Math.pow(2,16)),s=new Blob([e],{type:"application/octet-stream"}),i=URL.createObjectURL(s),a=yield fetch(i);const n=(yield a.body).getReader();for(;!(yield n.read()).done;);t.streaming=!0}catch(t){console.log("Streaming capability detection failed. Assuming fallback.")}t.mediaSession="mediaSession"in navigator;var e=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./),s=!!e&&parseInt(e[2],10);return!1!==s&&s>=89&&(t.sampleRate=!1),t}))}(),this._setMediaSessionData(t),this._state.capabilities.mediaSession&&(navigator.mediaSession.playbackState="playing"),this._state.stopped=!1,console.log(`Playing ${e}`),this._state.hasInitialized||this.sendEvent(o.start,{loaded:this._state.samplesReady}),this._state.playAudioRunning)return;var s,i;this._state.playAudioRunning=!0,this._state.fullyLoaded||(console.log("Cancelling last stream..."),this._state.streamCancel=!0,yield(s="continueload",new Promise((t=>{let e=i=>{i.data===s&&i.isTrusted&&(window.removeEventListener("message",e),t())};window.addEventListener("message",e)}))),console.log("Done.")),this._state.audioContext&&(yield this._state.audioContext.close(),this._state.audioContext=null),this._state.playbackCurrentSample=0,this._state.paused=!1,this.sendEvent(o.resetState,{ready:!1,position:0,samples:1e6,loaded:0,volume:this._state.volume,paused:!1,buffering:!1,sampleRate:44100,streamingDied:!1});try{yield(this._state.capabilities.streaming?this.loadSongStreaming.bind(this):this.loadSongLegacy.bind(this))(e)}catch(t){return this.sendEvent(o.killed,{streamingDied:!0,buffering:!1,ready:!0}),console.error(t),void(this._state.playAudioRunning=!1)}this._state.audioContext=new window.AudioContext(this._state.capabilities.sampleRate?{sampleRate:this._state.brstm.metadata.sampleRate}:{}),this._state.enableLoop=1===this._state.brstm.metadata.loopFlag,yield function(t){return new Promise((e=>z(this,void 0,void 0,(function*(){let s=!1,i=document.createElement("div");i.setAttribute("style","background: #888a; z-index: 88888; position: fixed; top: 0; bottom: 0; left: 0; right: 0; display: flex; align-items: center; justify-content: center;");let a=document.createElement("div");a.setAttribute("style","display: flex; align-items: center; justify-content: center; flex-direction: column"),a.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" version="1.0"  width="200" height="200" viewBox="0 0 75 75">\n<path d="M39.389,13.769 L22.235,28.606 L6,28.606 L6,47.699 L21.989,47.699 L39.389,62.75 L39.389,13.769z"\nstyle="stroke:#fff;stroke-width:5;stroke-linejoin:round;fill:#fff;"\n/>\n<path d="M48,27.6a19.5,19.5 0 0 1 0,21.4M55.1,20.5a30,30 0 0 1 0,35.6M61.6,14a38.8,38.8 0 0 1 0,48.6" style="fill:none;stroke:#fff;stroke-width:5;stroke-linecap:round"/>\n</svg><h1 style="font-family: sans-serif; color: white; margin: 0;">Tap or click anywhere to enable audio.</h1>',i.appendChild(a),setTimeout((function(){s||document.body.appendChild(i)}),200),t.onstatechange=function(){"running"==t.state&&(e(),i.remove(),s=!0)};try{t.resume()}catch(t){console.error(t)}i.addEventListener("touchend",(function(){return z(this,void 0,void 0,(function*(){yield t.resume(),"running"===t.state&&(e(),i.remove(),s=!0)}))})),i.addEventListener("click",(function(){return z(this,void 0,void 0,(function*(){yield t.resume(),"running"===t.state&&(e(),i.remove(),s=!0)}))})),"running"===t.state&&(e(),i.remove(),s=!0)}))))}(this._state.audioContext),this._state.capabilities.streaming&&(yield(i=1e3,new Promise((t=>setTimeout(t,i))))),this._state.scriptNode=this._state.audioContext.createScriptProcessor(0,0,2);let a=this._state.scriptNode.bufferSize;a=this._state.capabilities.sampleRate?a:this.getResampledSample(this._state.audioContext.sampleRate,this._state.brstm.metadata.sampleRate,a);let n=a;this._state.capabilities.sampleRate||(n+=20),this.sendEvent(o.loaded,{ready:!0,samples:this._state.brstm.metadata.totalSamples,sampleRate:this._state.brstm.metadata.sampleRate}),this._state.playAudioRunning=!1,this._state.scriptNode.onaudioprocess=t=>{if(!0===this._state.stopped)return;this.sendUpdateStateEvent();let e,s=t.outputBuffer;if(s.copyToChannel||(s.copyToChannel=W),this._state.playbackCurrentSample+a+1024>this._state.samplesReady)return this.sendEvent(o.buffering,{buffering:!0}),console.log("Buffering...."),s.copyToChannel(new Float32Array(this._state.scriptNode.bufferSize).fill(0),0),void s.copyToChannel(new Float32Array(this._state.scriptNode.bufferSize).fill(0),1);if(this.sendEvent(o.buffering,{buffering:!1}),this._state.paused)return s.copyToChannel(new Float32Array(this._state.scriptNode.bufferSize).fill(0),0),void s.copyToChannel(new Float32Array(this._state.scriptNode.bufferSize).fill(0),1);if(this._state.playbackCurrentSample+n<this._state.brstm.metadata.totalSamples)e=_t(this._state.brstm,this._state.playbackCurrentSample,n),this._state.playbackCurrentSample+=a;else if(this._state.enableLoop){e=_t(this._state.brstm,this._state.playbackCurrentSample,this._state.brstm.metadata.totalSamples-this._state.playbackCurrentSample);let t=e[0].length;console.log(this._state.brstm.metadata.totalSamples-this._state.playbackCurrentSample,n-t);let s=_t(this._state.brstm,this._state.brstm.metadata.loopStartSample,n-t);for(let t=0;t<e.length;t++){let i=new Int16Array(n).fill(0);i.set(e[t]),i.set(s[t],e[t].length),e[t]=i}this._state.playbackCurrentSample=this._state.brstm.metadata.loopStartSample+a-t}else{e=_t(this._state.brstm,this._state.playbackCurrentSample,this._state.brstm.metadata.totalSamples-this._state.playbackCurrentSample-1);for(let t=0;t<e.length;t++){let s=new Int16Array(n).fill(0);s.set(e[t]),e[t]=s}this._state.playbackCurrentSample=0,this._state.paused=!0,setTimeout((()=>{this._state.audioContext.suspend()}),200)}e.length>2&&(e=[e[0],e[1]]),1===e.length&&(e=[e[0],e[0]]);for(let t=0;t<e.length;t++){let i=new Float32Array(n);for(let s=0;s<n;s++)i[s]=e[t][s]/32768;if(!this._state.capabilities.sampleRate){let t=new I(this._state.brstm.metadata.sampleRate,this._state.audioContext.sampleRate,1,i);t.resampler(n),i=new Float32Array(t.outputBuffer),i.length>this._state.scriptNode.bufferSize&&(i=i.slice(0,this._state.scriptNode.bufferSize))}s.copyToChannel(i,t)}},this._state.gainNode=this._state.audioContext.createGain(),this._state.scriptNode.connect(this._state.gainNode),this._state.gainNode.connect(this._state.audioContext.destination),this._state.gainNode.gain.setValueAtTime(this._state.volume,this._state.audioContext.currentTime)}))}_setMediaSessionData(t){return vt(this,void 0,void 0,(function*(){this._state.capabilities.mediaSession&&this._audio.play().then((e=>{navigator.mediaSession.metadata=new MediaMetadata({title:t.name,album:t.game_name,artist:t.uploader,artwork:[{src:"https://ssb.wiki.gallery/images/a/a2/SSBU_spirit_Smash_Ball.png",type:"image/png",sizes:"560x544"}]}),navigator.mediaSession.setActionHandler("play",(()=>{this.playPause()})),navigator.mediaSession.setActionHandler("pause",(()=>{this.playPause()})),navigator.mediaSession.setActionHandler("stop",(()=>{this.stop()})),navigator.mediaSession.setActionHandler("nexttrack",(()=>this.next)),navigator.mediaSession.setActionHandler("previoustrack",(()=>this.previous))})).catch((t=>{console.error(t)}))}))}}("https://smashcustommusic.net/brstm");O.runGUI(bt),window.player=bt}();
