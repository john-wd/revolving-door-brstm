!function(){"use strict";var t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function e(t){var e={exports:{}};return t(e,e.exports),e.exports}var a=e((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.ARTWORK_URL=e.SILENCE_URL=e.SMASHCUSTOMMUSIC_URL=e.PLAYER_TAG_ID=e.STREAMING_MIN_RESPONSE=void 0,e.STREAMING_MIN_RESPONSE=Math.pow(2,19),e.PLAYER_TAG_ID="brstm_player",e.SMASHCUSTOMMUSIC_URL="https://smashcustommusic.net",e.SILENCE_URL="https://github.com/anars/blank-audio/blob/master/5-seconds-of-silence.mp3?raw=true",e.ARTWORK_URL="https://ssb.wiki.gallery/images/a/a2/SSBU_spirit_Smash_Ball.png"}));var s=function(t,e){let a=this.getChannelData(e);for(let e=0;e<t.length;e++)a[e]=t[e]},i=Object.defineProperty({default:s},"__esModule",{value:!0});var n=class{constructor(t,e,a,s){if(this._fromSampleRate=t,this._toSampleRate=e,this._channels=0|a,"object"!=typeof s)throw new Error("inputBuffer is not an object.");if(!(s instanceof Array||s instanceof Float32Array||s instanceof Float64Array))throw new Error("inputBuffer is not an array or a float32 or a float64 array.");this._inputBuffer=s,this._outputBuffer=new Float32Array,this._lastOutput=new Float32Array,this._resampler=this.linerarInterpolationFn,this._ratioWeight=1,this._lastWeight=1,this._tailExists=!1,this.initialize()}initialize(){if(!(this._fromSampleRate>0&&this._toSampleRate>0&&this._channels>0))throw new Error("Invalid settings specified for the resampler.");this._fromSampleRate==this._toSampleRate?(this._resampler=this.bypassResampler,this._ratioWeight=1,this._outputBuffer=this._inputBuffer):(this._ratioWeight=this._fromSampleRate/this._toSampleRate,this._fromSampleRate<this._toSampleRate?(this._resampler=this.linerarInterpolationFn,this._lastWeight=1):(this._resampler=this.multiTapFn,this._tailExists=!1,this._lastWeight=0),this.initializeBuffers())}initializeBuffers(){var t=Math.ceil(this._inputBuffer.length*this._toSampleRate/this._fromSampleRate/this._channels*1.0000004768371582)*this._channels+this._channels;try{this._outputBuffer=new Float32Array(t),this._lastOutput=new Float32Array(this._channels)}catch(t){this._outputBuffer=new Float32Array([]),this._lastOutput=new Float32Array([])}}bypassResampler(t){return t}multiTapFn(t){var e=0;if(t>0){for(var a=this._inputBuffer,s=0,i=[],n=0;n<this._channels;++n)i[0]=0;var l=0,o=0,r=!this._tailExists;this._tailExists=!1;var h=this._outputBuffer,d=0;do{for(r?(s=this._ratioWeight,i.forEach(((t,e)=>{i[e]=0}))):(s=this._lastWeight,i.forEach(((t,e)=>{i[e]=this._lastOutput[e]})),r=!0);s>0&&l<t;){if(!(s>=(o=1+l-d))){i.forEach(((t,e)=>{i[e]+=a[l+e]*s})),d+=s,s=0;break}i.forEach(((t,e)=>{i[e]+=a[l++]*o})),d=l,s-=o}if(!(s<=0)){this._lastWeight=s,i.forEach(((t,e)=>{this._lastOutput[e]=t})),this._tailExists=!0;break}i.forEach((t=>{h[e++]=t/this._ratioWeight}))}while(l<t)}return e}linerarInterpolationFn(t){var e=0;if(t>0){for(var a=this._inputBuffer,s=this._lastWeight,i=0,n=0,l=0,o=(e=0,this._outputBuffer);s<1;s+=this._ratioWeight){i=1-(n=s%1);for(var r=0;r<this._channels;++r)o[e++]=this._lastOutput[r]*i+a[r]*n}for(s-=1,t-=this._channels,l=Math.floor(s)*this._channels;l<t;){i=1-(n=s%1);for(r=0;r<this._channels;++r)o[e++]=a[l+r]*i+a[l+r+this._channels]*n;s+=this._ratioWeight,l=Math.floor(s)*this._channels}for(r=0;r<this._channels;++r)this._lastOutput[r]=a[l++];this._lastWeight=s%1}return e}get outputBuffer(){return this._outputBuffer}get resampler(){return this._resampler}},l=Object.defineProperty({default:n},"__esModule",{value:!0}),o=t&&t.__awaiter||function(t,e,a,s){return new(a||(a=Promise))((function(i,n){function l(t){try{r(s.next(t))}catch(t){n(t)}}function o(t){try{r(s.throw(t))}catch(t){n(t)}}function r(t){var e;t.done?i(t.value):(e=t.value,e instanceof a?e:new a((function(t){t(e)}))).then(l,o)}r((s=s.apply(t,e||[])).next())}))};var r=function(t){return new Promise((e=>o(this,void 0,void 0,(function*(){let a=!1,s=document.createElement("div");s.setAttribute("style","background: #888a; z-index: 88888; position: fixed; top: 0; bottom: 0; left: 0; right: 0; display: flex; align-items: center; justify-content: center;");let i=document.createElement("div");i.setAttribute("style","display: flex; align-items: center; justify-content: center; flex-direction: column"),i.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" version="1.0"  width="200" height="200" viewBox="0 0 75 75">\n<path d="M39.389,13.769 L22.235,28.606 L6,28.606 L6,47.699 L21.989,47.699 L39.389,62.75 L39.389,13.769z"\nstyle="stroke:#fff;stroke-width:5;stroke-linejoin:round;fill:#fff;"\n/>\n<path d="M48,27.6a19.5,19.5 0 0 1 0,21.4M55.1,20.5a30,30 0 0 1 0,35.6M61.6,14a38.8,38.8 0 0 1 0,48.6" style="fill:none;stroke:#fff;stroke-width:5;stroke-linecap:round"/>\n</svg><h1 style="font-family: sans-serif; color: white; margin: 0;">Tap or click anywhere to enable audio.</h1>',s.appendChild(i),setTimeout((function(){a||document.body.appendChild(s)}),200),t.onstatechange=function(){"running"==t.state&&(e(),s.remove(),a=!0)};try{t.resume()}catch(t){console.error(t)}s.addEventListener("touchend",(function(){return o(this,void 0,void 0,(function*(){yield t.resume(),"running"===t.state&&(e(),s.remove(),a=!0)}))})),s.addEventListener("click",(function(){return o(this,void 0,void 0,(function*(){yield t.resume(),"running"===t.state&&(e(),s.remove(),a=!0)}))})),"running"===t.state&&(e(),s.remove(),a=!0)}))))},h=Object.defineProperty({default:r},"__esModule",{value:!0}),d=e((function(e,a){var s=t&&t.__awaiter||function(t,e,a,s){return new(a||(a=Promise))((function(i,n){function l(t){try{r(s.next(t))}catch(t){n(t)}}function o(t){try{r(s.throw(t))}catch(t){n(t)}}function r(t){var e;t.done?i(t.value):(e=t.value,e instanceof a?e:new a((function(t){t(e)}))).then(l,o)}r((s=s.apply(t,e||[])).next())}))};Object.defineProperty(a,"__esModule",{value:!0}),a.browserCapabilities=void 0,a.browserCapabilities=function(){return s(this,void 0,void 0,(function*(){let t={sampleRate:!1,streaming:!1,mediaSession:!1};try{let e=new(window.AudioContext||AudioContext)({sampleRate:8e3});t.sampleRate=8e3===e.sampleRate,e.close()}catch(t){console.log("WebAudio sample rate capability detection failed. Assuming fallback.")}try{let e=new Uint8Array(Math.pow(2,16)),a=new Blob([e],{type:"application/octet-stream"}),s=URL.createObjectURL(a),i=yield fetch(s),n=yield i.body;if(!n)throw"could not get body";const l=n.getReader();for(;;){if((yield l.read()).done)break}t.streaming=!0}catch(t){console.log("Streaming capability detection failed. Assuming fallback.")}t.mediaSession="mediaSession"in navigator;var e=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./),a=!!e&&parseInt(e[2],10);return!1!==a&&a>=89&&(t.sampleRate=!1),t}))}})),u=e((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.awaitMessage=e.powersOf2=e.sleep=void 0;e.sleep=t=>new Promise((e=>setTimeout(e,t))),e.powersOf2=[256,512,1024,2048,4096,8192,16384,32768],e.awaitMessage=function(t){return new Promise((e=>{let a=s=>{s.data===t&&s.isTrusted&&(window.removeEventListener("message",a),e())};window.addEventListener("message",a)}))}})),p=e((function(t,e){var a=(t,e,a)=>{if(!e.has(t))throw TypeError("Cannot "+a)},s=(t,e,s)=>(a(t,e,"read from private field"),s?s.call(t):e.get(t)),i=(t,e,a)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,a)},n=(t,e,s,i)=>(a(t,e,"write to private field"),i?i.call(t,s):e.set(t,s),s),l=(t,e,s)=>(a(t,e,"access private method"),s);function o(t,e,a){const s=[];for(let i=e;i<e+a;i++)s.push(t[i]);return s}Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const r=0,h=1;function d(t,e,a,s=h){const i=o(t,e,a);return s===r&&i.reverse(),i.reduce(((t,e)=>256*t+e),0)}function u(t,e,a){return t<=e?e:t>=a?a:t}function p(t){return t>=32768?t-65536:t}var c,m,f,y,v,g,_,b,S,w,E,k,R,M,C,L,A,P,x,B;c=new WeakMap,m=new WeakMap,f=new WeakMap,y=new WeakMap,v=new WeakMap,g=new WeakMap,_=new WeakMap,b=new WeakMap,S=new WeakMap,w=new WeakMap,E=new WeakSet,k=function(){if(s(this,S))return s(this,S);const{numberChannels:t}=this.metadata,e=[];for(let a=0;a<t;a++){const t=s(this,c)+d(this.rawData,s(this,y)+8+8*a,4,this.endianness)+8+8,i=[];for(let e=0;e<16;e++){const a=d(this.rawData,t+2*e,2,this.endianness);i.push(p(a))}e.push({adpcmCoefficients:i,gain:d(this.rawData,t+40,2,this.endianness),initialPredictorScale:d(this.rawData,t+42,2,this.endianness),historySample1:d(this.rawData,t+44,2,this.endianness),historySample2:d(this.rawData,t+46,2,this.endianness),loopPredictorScale:d(this.rawData,t+48,2,this.endianness),loopHistorySample1:d(this.rawData,t+50,2,this.endianness),loopHistorySample2:d(this.rawData,t+52,2,this.endianness)})}return n(this,S,e),e},R=new WeakSet,M=function(){const t=d(this.rawData,s(this,m)+2,1,this.endianness),e=d(this.rawData,s(this,f),1,this.endianness),a=d(this.rawData,s(this,f)+1,1,this.endianness),i=[];for(let t=0;t<e;t++){const e=s(this,c)+8+d(this.rawData,s(this,f)+4+8*t+4,4,this.endianness),a=d(this.rawData,s(this,f)+4+8*t+1,1,this.endianness);let n=0;0===a?n=d(this.rawData,e,1,this.endianness):1===a&&(n=d(this.rawData,e+8,1,this.endianness)),i.push({numberChannels:n,type:a})}const n={fileSize:d(this.rawData,8,4,this.endianness),endianness:this.endianness,codec:d(this.rawData,s(this,m),1,this.endianness),loopFlag:d(this.rawData,s(this,m)+1,1,this.endianness),numberChannels:t,sampleRate:d(this.rawData,s(this,m)+4,2,this.endianness),loopStartSample:d(this.rawData,s(this,m)+8,4,this.endianness),totalSamples:d(this.rawData,s(this,m)+12,4,this.endianness),totalBlocks:d(this.rawData,s(this,m)+20,4,this.endianness),blockSize:d(this.rawData,s(this,m)+24,4,this.endianness),samplesPerBlock:d(this.rawData,s(this,m)+28,4,this.endianness),finalBlockSize:d(this.rawData,s(this,m)+32,4,this.endianness),finalBlockSizeWithPadding:d(this.rawData,s(this,m)+40,4,this.endianness),totalSamplesInFinalBlock:d(this.rawData,s(this,m)+36,4,this.endianness),adpcTableSamplesPerEntry:d(this.rawData,s(this,m)+44,4,this.endianness),adpcTableBytesPerEntry:d(this.rawData,s(this,m)+48,4,this.endianness),numberTracks:e,trackDescriptionType:a,trackDescriptions:i};return n.loopStartSample>=n.totalSamples&&(n.loopFlag=0,n.loopStartSample=0,console.warn("The loop start sample in this file is invalid.")),n},C=new WeakSet,L=function(t){const{blockSize:e,totalBlocks:a,numberChannels:i,finalBlockSize:n,finalBlockSizeWithPadding:l}=this.metadata,o=[];for(let s=0;s<i;s++)o.push(new Uint8Array(t===a-1?n:e));let r=t;for(let t=0;t<i;t++){const h=0!==t&&r+1===a?r*i*e+t*l:(r*i+t)*e,d=r+1===a?h+n:h+e,u=this.rawData.slice(s(this,g)+32+h,s(this,g)+32+d);o[t].set(u)}return o},A=new WeakSet,P=function(){if(s(this,b))return s(this,b);const{totalBlocks:t,numberChannels:e}=this.metadata,a=d(this.rawData,s(this,v)+4,4,this.endianness),i=this.rawData.slice(s(this,v)+8,s(this,v)+8+a);let l=0,o=0,r=0;for(let t=0;t<e;t++)o=p(d(i,l,2,this.endianness)),l+=2,r=p(d(i,l,2,this.endianness)),l+=2;const h=[];for(let a=0;a<t;a++){h.push([]);for(let t=0;t<e;t++)a>0&&(o=p(d(i,l,2,this.endianness)),l+=2,r=p(d(i,l,2,this.endianness)),l+=2),h[a].push({yn1:o,yn2:r})}let u=[];for(let t=0;t<e;t++)u.push(h.map((e=>e[t])));return n(this,b,u),u},x=new WeakSet,B=function(t){if(s(this,w)[t])return s(this,w)[t];const{numberChannels:e,totalBlocks:a,totalSamplesInFinalBlock:i,samplesPerBlock:n,codec:o}=this.metadata,r=l(this,E,k).call(this),h=l(this,C,L).call(this,t),c=l(this,A,P).call(this),m=[],f=t===a-1?i:n;for(let t=0;t<e;t++)m.push(new Int16Array(f));for(let s=0;s<e;s++){const{adpcmCoefficients:e}=r[s],i=h[s],n=[];if(2===o){const l=i[0],{yn1:o,yn2:r}=c[s][t];let h=l,d=o,p=r,m=0;for(let t=0;t<f;){let a=0;t%14==0&&(h=i[m++]),a=0==(1&t++)?i[m]>>4:15&i[m++],a>=8&&(a-=16);const s=h>>4<<1;a=1024+((1<<(15&h))*a<<11)+e[u(s,0,15)]*d+e[u(s+1,0,15)]*p>>11,p=d,d=u(a,-32768,32767),n.push(d)}t<a-1&&(c[s][t+1].yn1=n[f-1],c[s][t+1].yn2=n[f-2])}else if(1===o)for(let t=0;t<f;t++){const e=p(d(i,2*t,2,this.endianness));n.push(e)}else{if(0!==o)throw new Error("Invalid codec");for(let t=0;t<f;t++)n.push(256*p(i[t]))}m[s].set(n)}return s(this,w)[t]=m,m},e.Brstm=class{constructor(t){if(i(this,E),i(this,R),i(this,C),i(this,A),i(this,x),i(this,c,void 0),i(this,m,void 0),i(this,f,void 0),i(this,y,void 0),i(this,v,void 0),i(this,g,void 0),i(this,_,void 0),i(this,b,void 0),i(this,S,void 0),i(this,w,void 0),n(this,_,null),n(this,b,null),n(this,S,null),n(this,w,[]),this.rawData=new Uint8Array(t),"RSTM"!==function(t,e,a,s=h){const i=o(t,e,a);return s===r&&i.reverse(),String.fromCharCode(...i)}(this.rawData,0,4))throw new Error("Not a valid BRSTM file");this.endianness=function(t){const e=o(t,4,2);return 255===e[0]&&254===e[1]?r:h}(this.rawData),n(this,c,d(this.rawData,16,4,this.endianness)),n(this,m,s(this,c)+d(this.rawData,s(this,c)+12,4,this.endianness)+8),n(this,f,s(this,c)+d(this.rawData,s(this,c)+20,4,this.endianness)+8),n(this,y,s(this,c)+d(this.rawData,s(this,c)+28,4,this.endianness)+8),n(this,v,d(this.rawData,24,4,this.endianness)),n(this,g,d(this.rawData,32,4,this.endianness)),this.metadata=l(this,R,M).call(this)}getAllSamples(){if(s(this,_))return s(this,_);const{numberChannels:t,totalSamples:e,totalBlocks:a,samplesPerBlock:i}=this.metadata,o=[];for(let a=0;a<t;a++)o.push(new Int16Array(e));for(let e=0;e<a;e++){const a=l(this,x,B).call(this,e);for(let s=0;s<t;s++)o[s].set(a[s],e*i)}return n(this,_,o),o}getBuffer(t,e){return this.getSamples(t,e)}getSamples(t,e){const{numberChannels:a,totalBlocks:s,totalSamples:i,samplesPerBlock:n}=this.metadata,o=Math.max(0,t),r=Math.min(i,t+e),h=Math.max(0,Math.floor(o/n)),d=Math.min(s-1,Math.floor(r/n)),u=[];for(let t=h;t<=d;t++)u.push(l(this,x,B).call(this,t));const p=[];for(let t=0;t<a;t++)p.push(new Int16Array(r-o));for(let t=h;t<=d;t++){const s=t-h;if(t===h&&t===d)for(let t=0;t<a;t++)p[t].set(u[s][t].slice(o-h*n,o-h*n+e),0);else if(t===h)for(let t=0;t<a;t++){const e=u[s][t].slice(o-h*n);p[t].set(e,0)}else if(t===d)for(let i=0;i<a;i++){const a=u[s][i].slice(0,r-u[s][i].length-h*n);a.length+(t*n-o)>p[i].length?p[i].set(a.slice(0,e-(t*n-o)),t*n-o):p[i].set(a,t*n-o)}else for(let e=0;e<a;e++)p[e].set(u[s][e],t*n-o)}return p}}})),c=e((function(t,e){var a;Object.defineProperty(e,"__esModule",{value:!0}),e.PlayerEvent=void 0,(a=e.PlayerEvent||(e.PlayerEvent={})).start="brstm_start",a.play="brstm_play",a.pause="brstm_pause",a.playPause="brstm_playpause",a.stop="brstm_stop",a.next="brstm_next",a.previous="brstm_previous",a.seek="brstm_seek",a.setLoop="brstm_setloop",a.setVolume="brstm_setvolume",a.buffering="brstm_buffering",a.loading="brstm_loading",a.loaded="brstm_loaded",a.killed="brstm_killed",a.step="brstm_step",a.resetState="brstm_resetstate",a.playlistAdd="brstm_playlist_add",a.playlistRemove="brstm_playlist_remove"})),m=p,f=e((function(e,s){var n=t&&t.__awaiter||function(t,e,a,s){return new(a||(a=Promise))((function(i,n){function l(t){try{r(s.next(t))}catch(t){n(t)}}function o(t){try{r(s.throw(t))}catch(t){n(t)}}function r(t){var e;t.done?i(t.value):(e=t.value,e instanceof a?e:new a((function(t){t(e)}))).then(l,o)}r((s=s.apply(t,e||[])).next())}))},o=t&&t.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(s,"__esModule",{value:!0}),s.BrstmPlayer=void 0;const r=o(i),p=o(l),f=o(h);function y(t,e,a){let s=[],i=0;for(let e=0;e<t.metadata.numberChannels;e++)s.push(new Int16Array(a));for(;i<a;){let n=t.getSamples(e+i,Math.min(t.metadata.samplesPerBlock,a-i));for(let t=0;t<n.length;t++)s[t].set(n[t],i);i+=Math.min(t.metadata.samplesPerBlock,a-i)}return s}s.BrstmPlayer=class{constructor(){this._state={hasInitialized:!1,capabilities:{},audioContext:new AudioContext,scriptNode:{},gainNode:{},fullyLoaded:!0,loadState:0,playbackCurrentSample:0,brstm:{},brstmBuffer:new ArrayBuffer(0),paused:!1,stopped:!1,enableLoop:!1,streamCancel:!1,playAudioRunning:!1,volume:Number(localStorage.getItem("volumeoverride"))||1,samplesReady:0},this._audio=document.createElement("audio"),this._audio.id=a.PLAYER_TAG_ID,this._audio.src=a.SILENCE_URL,this._audio.loop=!0,document.body.appendChild(this._audio)}sendEvent(t,e={}){this._audio.dispatchEvent(new CustomEvent(t,{detail:e,bubbles:!0}))}sendUpdateStateEvent(){this.sendEvent(c.PlayerEvent.step,{position:this._state.playbackCurrentSample,paused:this._state.paused,volume:this._state.volume,loaded:this._state.samplesReady,looping:this._state.enableLoop})}getResampledSample(t,e,a){return Math.ceil(a/t*e)}loadSongLegacy(t){return n(this,void 0,void 0,(function*(){let e=yield fetch(t),a=yield e.arrayBuffer();this._state.brstm=new m.Brstm(a),this._state.fullyLoaded=!0,this._state.loadState=Number.MAX_SAFE_INTEGER,this._state.samplesReady=Number.MAX_SAFE_INTEGER}))}loadSongStreaming(t){return new Promise(((e,s)=>n(this,void 0,void 0,(function*(){let i,n;this.sendEvent(c.PlayerEvent.loading);try{i=yield fetch(t);let e=yield i.body;if(!e)throw"could not read body";n=e.getReader();let a=i.headers.get("content-length");if(!a)throw"could not read content-length header";this._state.brstmBuffer=new ArrayBuffer(parseInt(a))}catch(t){return s(t)}let l=new Uint8Array(this._state.brstmBuffer),o=0,r=!1,h=0;for(this._state.samplesReady=0,this._state.fullyLoaded=!1,this._state.streamCancel=!1;;){let t;try{t=yield n.read()}catch(t){return void(r?(this.sendEvent(c.PlayerEvent.killed,{streamingDied:!0,buffering:!1,ready:!0}),yield this._state.audioContext.close(),this._state.audioContext={}):s(t))}if(this._state.streamCancel)return yield n.cancel(),void window.postMessage("continueload");if(t.done){if(!r)try{this._state.brstm=new m.Brstm(this._state.brstmBuffer),e(),r=!0}catch(t){return void s(t)}this._state.fullyLoaded=!0,this._state.samplesReady=Number.MAX_SAFE_INTEGER,console.log("File finished streaming");break}if(l.set(t.value,o),o+=t.value.length,this._state.loadState=o,0==h&&o>128){let t=0;65279==256*l[4]+l[5]&&(t=1),h=1==t?16777216*l[112]+65536*l[113]+256*l[114]+l[115]:l[112]+256*l[113]+65536*l[114]+16777216*l[115],h<144&&(h=a.STREAMING_MIN_RESPONSE)}if(!r&&0!=h&&o>h)try{this._state.brstm=new m.Brstm(this._state.brstmBuffer),e(),r=!0}catch(t){return void s(t)}r&&(this._state.samplesReady=Math.floor((this._state.loadState-h)/this._state.brstm.metadata.numberChannels/this._state.brstm.metadata.blockSize)*this._state.brstm.metadata.samplesPerBlock)}}))))}get totalSamples(){return this._state.brstm?this._state.brstm.metadata.totalSamples:-1}get sampleRate(){return this._state.brstm?this._state.brstm.metadata.sampleRate:-1}getSongLength(){return this.totalSamples/this.sampleRate}setVolume(t){this._state.volume=t,this.sendEvent(c.PlayerEvent.setVolume,{volume:t}),this.sendUpdateStateEvent(),this._state.gainNode&&this._state.gainNode.gain.setValueAtTime(this._state.volume,this._state.audioContext.currentTime)}incVolume(t){this.setVolume(Math.min(this._state.volume+t,1))}decVolume(t){this.setVolume(Math.max(this._state.volume-t,0))}seek(t){this._state.playbackCurrentSample=Math.floor(t),this.sendEvent(c.PlayerEvent.seek,{toSample:this._state.playbackCurrentSample}),this.sendUpdateStateEvent()}playPause(){this._state.paused=!this._state.paused,this._state.audioContext[this._state.paused?"suspend":"resume"](),this._state.capabilities.mediaSession&&(navigator.mediaSession.playbackState="playing"===navigator.mediaSession.playbackState?"paused":"playing"),this.sendEvent(c.PlayerEvent.playPause,{playing:"playing"===navigator.mediaSession.playbackState}),this.sendUpdateStateEvent()}setLoop(t){this._state.enableLoop=t,this.sendEvent(c.PlayerEvent.setLoop,{loop:t}),this.sendUpdateStateEvent()}stop(){this._state.stopped=!0,this.sendEvent(c.PlayerEvent.stop)}play(t,e){return n(this,void 0,void 0,(function*(){if(this.sendEvent(c.PlayerEvent.play,Object.assign(Object.assign({},e),{url:t})),this._state.capabilities=yield(0,d.browserCapabilities)(),this._setMediaSessionData(e),this._state.capabilities.mediaSession&&(navigator.mediaSession.playbackState="playing"),this._state.stopped=!1,console.log(`Playing ${t}`),this._state.hasInitialized||this.sendEvent(c.PlayerEvent.start,{loaded:this._state.samplesReady}),this._state.playAudioRunning)return;this._state.playAudioRunning=!0,this._state.fullyLoaded||(console.log("Cancelling last stream..."),this._state.streamCancel=!0,yield(0,u.awaitMessage)("continueload"),console.log("Done.")),this._state.audioContext&&(yield this._state.audioContext.close(),this._state.audioContext={}),this._state.playbackCurrentSample=0,this._state.paused=!1,this.sendEvent(c.PlayerEvent.resetState,{ready:!1,position:0,samples:1e6,loaded:0,volume:this._state.volume,paused:!1,buffering:!1,sampleRate:44100,streamingDied:!1});try{yield(this._state.capabilities.streaming?this.loadSongStreaming.bind(this):this.loadSongLegacy.bind(this))(t)}catch(t){return this.sendEvent(c.PlayerEvent.killed,{streamingDied:!0,buffering:!1,ready:!0}),console.error(t),void(this._state.playAudioRunning=!1)}this._state.audioContext=new window.AudioContext(this._state.capabilities.sampleRate?{sampleRate:this._state.brstm.metadata.sampleRate}:{}),this._state.enableLoop=1===this._state.brstm.metadata.loopFlag,yield(0,f.default)(this._state.audioContext),this._state.capabilities.streaming&&(yield(0,u.sleep)(1e3)),this._state.scriptNode=this._state.audioContext.createScriptProcessor(0,0,2);let a=this._state.scriptNode.bufferSize;a=this._state.capabilities.sampleRate?a:this.getResampledSample(this._state.audioContext.sampleRate,this._state.brstm.metadata.sampleRate,a);let s=a;this._state.capabilities.sampleRate||(s+=20),this.sendEvent(c.PlayerEvent.loaded,{ready:!0,samples:this._state.brstm.metadata.totalSamples,sampleRate:this._state.brstm.metadata.sampleRate}),this._state.playAudioRunning=!1,this._state.scriptNode.onaudioprocess=t=>{if(!0===this._state.stopped)return;this.sendUpdateStateEvent();let e,i=t.outputBuffer;if(i.copyToChannel||(i.copyToChannel=r.default),this._state.playbackCurrentSample+a+1024>this._state.samplesReady)return this.sendEvent(c.PlayerEvent.buffering,{buffering:!0}),console.log("Buffering...."),i.copyToChannel(new Float32Array(this._state.scriptNode.bufferSize).fill(0),0),void i.copyToChannel(new Float32Array(this._state.scriptNode.bufferSize).fill(0),1);if(this.sendEvent(c.PlayerEvent.buffering,{buffering:!1}),this._state.paused)return i.copyToChannel(new Float32Array(this._state.scriptNode.bufferSize).fill(0),0),void i.copyToChannel(new Float32Array(this._state.scriptNode.bufferSize).fill(0),1);if(this._state.playbackCurrentSample+s<this._state.brstm.metadata.totalSamples)e=y(this._state.brstm,this._state.playbackCurrentSample,s),this._state.playbackCurrentSample+=a;else if(this._state.enableLoop){e=y(this._state.brstm,this._state.playbackCurrentSample,this._state.brstm.metadata.totalSamples-this._state.playbackCurrentSample);let t=e[0].length;console.log(this._state.brstm.metadata.totalSamples-this._state.playbackCurrentSample,s-t);let i=y(this._state.brstm,this._state.brstm.metadata.loopStartSample,s-t);for(let t=0;t<e.length;t++){let a=new Int16Array(s).fill(0);a.set(e[t]),a.set(i[t],e[t].length),e[t]=a}this._state.playbackCurrentSample=this._state.brstm.metadata.loopStartSample+a-t}else{e=y(this._state.brstm,this._state.playbackCurrentSample,this._state.brstm.metadata.totalSamples-this._state.playbackCurrentSample-1);for(let t=0;t<e.length;t++){let a=new Int16Array(s).fill(0);a.set(e[t]),e[t]=a}this._state.playbackCurrentSample=0,this._state.paused=!0,setTimeout((()=>{this._state.audioContext.suspend()}),200)}e.length>2&&(e=[e[0],e[1]]),1===e.length&&(e=[e[0],e[0]]);for(let t=0;t<e.length;t++){let a=new Float32Array(s);for(let i=0;i<s;i++)a[i]=e[t][i]/32768;if(!this._state.capabilities.sampleRate){let t=new p.default(this._state.brstm.metadata.sampleRate,this._state.audioContext.sampleRate,1,a);t.resampler(s),a=new Float32Array(t.outputBuffer),a.length>this._state.scriptNode.bufferSize&&(a=a.slice(0,this._state.scriptNode.bufferSize))}i.copyToChannel(a,t)}},this._state.gainNode=this._state.audioContext.createGain(),this._state.scriptNode.connect(this._state.gainNode),this._state.gainNode.connect(this._state.audioContext.destination),this._state.gainNode.gain.setValueAtTime(this._state.volume,this._state.audioContext.currentTime)}))}_setMediaSessionData(t){return n(this,void 0,void 0,(function*(){this._state.capabilities.mediaSession&&this._audio.play().then((e=>{t&&(navigator.mediaSession.metadata=new MediaMetadata({title:t.name,album:t.game_name,artist:t.uploader,artwork:[{src:a.ARTWORK_URL,type:"image/png",sizes:"560x544"}]})),navigator.mediaSession.setActionHandler("play",(()=>{this.playPause()})),navigator.mediaSession.setActionHandler("pause",(()=>{this.playPause()})),navigator.mediaSession.setActionHandler("stop",(()=>{this.stop()}))})).catch((t=>{console.error(t)}))}))}}})),y=e((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.runGestureEngine=e.getInstance=void 0;class a{constructor(){this.currentlyGesturing=!1,this.activeArea="",this.activeAreaElem=null,this.operationListeners=new Map,this.finishedListeners=new Map}sanitize(t,e){let a=this.activeAreaElem.getBoundingClientRect(),s=t-a.x,i=e-a.y;return s<0&&(s=0),i<0&&(i=0),s>a.width&&(s=a.width),i>a.height&&(i=a.height),[s,i]}fireOp(t,e,a){if(this.operationListeners.has(t)){let s=this.operationListeners.get(t);s&&s.forEach((t=>{t(e,a)}))}}fireFin(t,e,a){if(this.finishedListeners.has(t)){let s=this.operationListeners.get(t);s&&s.forEach((t=>{t(e,a)}))}}registerOpEvent(t,e){if(this.operationListeners.has(t)){let a=this.operationListeners.get(t);a&&(a.push(e),this.operationListeners.set(t,a))}else this.operationListeners.set(t,[e])}registerFinEvent(t,e){if(this.finishedListeners.has(t)){let a=this.finishedListeners.get(t);a&&(a.push(e),this.finishedListeners.set(t,a))}else this.finishedListeners.set(t,[e])}runGestureEngine(){i()}}let s=new a;function i(){document.addEventListener("mousedown",(function(t){if(t.target.dataset.gestureHitzone){s.currentlyGesturing=!0,s.activeArea=t.target.dataset.gestureHitzone,s.activeAreaElem=t.target;let[e,a]=s.sanitize(t.clientX,t.clientY);s.fireOp(s.activeArea,e,a)}})),document.addEventListener("mousemove",(function(t){if(s.currentlyGesturing){let[e,a]=s.sanitize(t.clientX,t.clientY);s.fireOp(s.activeArea,e,a)}})),document.addEventListener("mouseup",(function(t){if(s.currentlyGesturing){let[e,a]=s.sanitize(t.clientX,t.clientY);s.fireFin(s.activeArea,e,a),s.currentlyGesturing=!1,s.activeAreaElem=null,s.activeArea=""}}))}e.getInstance=function(){return null==s&&(s=new a),s},e.runGestureEngine=i})),v=e((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.runGUI=void 0;const s=y.getInstance();let i={display:!1,position:0,samples:1e6,loaded:5e5,volume:1,paused:!1,ready:!1,buffering:!1,sampleRate:48e3,looping:!1,streamingDied:!1},n={volume:null,position:null},l={},o=null,r=null,h=null,d=-30;function u(t){try{t.preventDefault()}catch(t){}if(t.targetTouches.length>0){let e=t.targetTouches[0].target.getBoundingClientRect(),a=t.targetTouches[0].clientY+t.targetTouches[0].radiusY-e.top;a<5&&(a=0),a>80&&(a=84);let s=1-a/84;n.volume=s,"touchend"===t.type&&(i.volume=n.volume,l.setVolume(n.volume),n.volume=null,localStorage.setItem("volumeoverride",s)),P()}else"touchend"===t.type&&(i.volume=n.volume,l.setVolume(n.volume),n.volume=null)}function p(t){try{t.preventDefault()}catch(t){}if(t.targetTouches.length>0){let e=t.targetTouches[0].target.getBoundingClientRect(),a=t.targetTouches[0].clientX+t.targetTouches[0].radiusX-e.left;if(a<5&&(a=0),a>254&&(a=254),a=Math.round(a),a===d)return;d=a;let s=i.samples*(a/254);s<i.loaded&&(n.position=s),"touchend"===t.type&&(l.seek(n.position),n.position=null),P()}else"touchend"===t.type&&(l.seek(n.position),n.position=null)}function m(t,e){let a=Math.round(t),s=i.samples*(a/254);s<i.loaded&&(n.position=s),P()}function f(t,e){let a=Math.round(t),s=i.samples*(a/254);s<i.loaded&&(n.position=s),l.seek(s),n.position=null,P()}function v(t,e){e=Math.round(e),n.volume=1-e/84,P()}function g(t,e){let a=1-(e=Math.round(e))/84;n.volume=null,localStorage.setItem("volumeoverride",a),l.setVolume(a),P()}e.runGUI=function(t){!function(){let t=document.getElementById(a.PLAYER_TAG_ID);t&&(t.addEventListener(c.PlayerEvent.step,(t=>{i=Object.assign(Object.assign({},i),{position:t.detail.position,paused:t.detail.paused,volume:t.detail.volume,loaded:t.detail.loaded,looping:t.detail.looping}),P()})),t.addEventListener(c.PlayerEvent.killed,(t=>{i=Object.assign(Object.assign({},i),{streamingDied:t.detail.streamingDied,buffering:t.detail.buffering,ready:t.detail.ready}),A()})),t.addEventListener(c.PlayerEvent.setVolume,(t=>{i.volume=t.detail.volume,P()})),t.addEventListener(c.PlayerEvent.seek,(t=>{i.position=t.detail.toSample,P()})),t.addEventListener(c.PlayerEvent.playPause,(t=>{i.paused=t.detail.playing,P()})),t.addEventListener(c.PlayerEvent.setLoop,(t=>{i.looping=t.detail.loop,P()})),t.addEventListener(c.PlayerEvent.stop,(t=>{A()})),t.addEventListener(c.PlayerEvent.start,(t=>{i.loaded=t.detail.loaded,i.display=!0,P()})),t.addEventListener(c.PlayerEvent.resetState,(t=>{i=Object.assign(Object.assign({},i),{ready:t.detail.ready,position:t.detail.position,samples:t.detail.samples,loaded:t.detail.loaded,volume:t.detail.volume,paused:t.detail.paused,buffering:t.detail.buffering,sampleRate:t.detail.sampleRate,streamingDied:t.detail.streamingDied}),P()})),t.addEventListener(c.PlayerEvent.loaded,(t=>{i=Object.assign(Object.assign({},i),{ready:t.detail.ready,samples:t.detail.samples,sampleRate:t.detail.sampleRate}),P()})),t.addEventListener(c.PlayerEvent.buffering,(t=>{i.buffering=t.detail.buffering,P()})))}(),l=t,h=document.createElement("div"),h.style.display="none",h.classList.add("guiholder"),h.innerHTML='\n<div class="error" style="display: none">\n    <h3>Playback failed!</h3>\n    <h3>Reload the page and try again.</h3>\n    <h3>If the issue continues, contact us.</h3>\n</div>\n<div id="gui-loading-bar">\n    <div id="gui-inner-loading-bar"></div>\n</div>\n<div class="guistate" data-guistate="preload">\n    <h3>Loading song...</h3>\n</div>\n<div class="guistate" data-guistate="ready">\n    <div id="pl-pause-play">\n        <svg width="48" height="48" viewBox="0 0 48 48" id="pl-play">\n            <path d="M 10, 10 l 0, 28 l 28, -14" fill="white"></path>\n        </svg>\n        <svg width="48" height="48" viewBox="0 0 48 48" id="pl-pause" style="display: none;">\n            <path d="M 10, 10 l 0, 28 l 10, 0 l 0, -28 M 28, 10 l 0, 28 l 10, 0 l 0, -28" fill="white"></path>\n        </svg>\n    </div>\n    <canvas id="pl-volume" width="16" height="84" data-gesture-hitzone="volume"></canvas>\n    <div id="pl-timing">\n        <span id="pl-time-start">0:00</span>\n        <span id="pl-time-end"  >0:00</span>\n    </div>\n    <canvas id="pl-seek" width="254" height="16" data-gesture-hitzone="seek"></canvas>\n    <div id="pl-loop">\n        <input type="checkbox" id="pl-loop-box" style="width: 16px; height: 16px; margin: 0;">\n        <span class="pl-loop-text">Enable loop</span>\n        <a class="pl-loop-text" target="_blank" href="https://smashcustommusic.net/feedback/">Send feedback</a>\n        <a class="pl-loop-text" target="_blank" href="https://github.com/rphsoftware/revolving-door">v2 by Rph</a>\n    </div>\n</div>',document.body.appendChild(h),o=document.querySelector("#pl-volume").getContext("2d"),r=document.querySelector("#pl-seek").getContext("2d"),document.querySelector("#pl-volume").addEventListener("touchstart",u),document.querySelector("#pl-volume").addEventListener("touchmove",u),document.querySelector("#pl-volume").addEventListener("touchend",u),document.querySelector("#pl-seek").addEventListener("touchstart",p),document.querySelector("#pl-seek").addEventListener("touchmove",p),document.querySelector("#pl-seek").addEventListener("touchend",p),document.querySelector("#pl-pause-play").addEventListener("click",(function(){l.playPause(),P()})),document.querySelector("#pl-loop-box").addEventListener("input",(function(){i.looping=document.querySelector("#pl-loop-box").checked,l.setLoop(i.looping)})),h.addEventListener("drag",(function(t){t.preventDefault()})),s.runGestureEngine(),s.registerOpEvent("seek",m),s.registerFinEvent("seek",f),s.registerOpEvent("volume",v),s.registerFinEvent("volume",g)};let _=null,b=null,S=-1,w=-1,E=null,k=-1,R=-1,M=null,C=-1,L=null;function A(){h&&(i.display=!1,h.style.display="none")}function P(){if(i.display&&(h.style.display="block"),h){L!==i.streamingDied&&(h.querySelector(".error").style.display=i.streamingDied?"flex":"none",L=i.streamingDied);let t=i.buffering||!i.ready;if(_!==t&&(h.querySelector("#gui-loading-bar").dataset.exists=t,_=t),b!==i.ready&&(h.querySelector('.guistate[data-guistate="preload"]').style.display=i.ready?"none":"block",h.querySelector('.guistate[data-guistate="ready"]').style.display=i.ready?"grid":"none",b=i.ready),!i.ready)return;let e=Math.round(84-84*i.volume);null!==n.volume&&(e=Math.round(84-84*n.volume)),e!==S&&(o.fillStyle="#444",o.fillRect(0,0,16,84),o.fillStyle="hsl(200, 85%, 55%)",o.fillRect(0,e,16,84),S=e);let a=Math.ceil(i.position/i.samples*254);null!==n.position&&(a=Math.ceil(n.position/i.samples*254));let s=Math.ceil(i.loaded/i.samples*254);a===w&&s===C||(r.fillStyle="#222",r.fillRect(0,0,254,16),r.fillStyle="#666",r.fillRect(0,0,Math.min(254,s),16),r.fillStyle="hsl(200, 85%, 55%)",r.fillRect(0,0,Math.min(254,a),16),w=a,C=s),E!==i.paused&&(h.querySelector("#pl-pause").style.display=i.paused?"none":"block",h.querySelector("#pl-play").style.display=i.paused?"block":"none",E=i.paused);let l=Math.floor(i.samples/i.sampleRate),d=Math.floor(i.position/i.sampleRate);null!==n.position&&(d=Math.floor(n.position/i.sampleRate)),l!==k&&(h.querySelector("#pl-time-end").innerText=`${Math.floor(l/60)}:${(l%60).toString().padStart(2,"0")}`,k=l),d!==R&&(h.querySelector("#pl-time-start").innerText=`${Math.floor(d/60)}:${(d%60).toString().padStart(2,"0")}`,R=d),M!==i.looping&&(h.querySelector("#pl-loop-box").checked=i.looping,M=i.looping)}}}));let g=new f.BrstmPlayer;v.runGUI(g),window.player=g}();
