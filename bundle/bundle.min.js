!function(){"use strict";var t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function e(t){var e={exports:{}};return t(e,e.exports),e.exports}var s=e((function(t,e){var s=(t,e,s)=>{if(!e.has(t))throw TypeError("Cannot "+s)},a=(t,e,a)=>(s(t,e,"read from private field"),a?a.call(t):e.get(t)),i=(t,e,s)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,s)},n=(t,e,a,i)=>(s(t,e,"write to private field"),i?i.call(t,a):e.set(t,a),a),l=(t,e,a)=>(s(t,e,"access private method"),a);function o(t,e,s){const a=[];for(let i=e;i<e+s;i++)a.push(t[i]);return a}Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const r=0,h=1;function d(t,e,s,a=h){const i=o(t,e,s);return a===r&&i.reverse(),i.reduce(((t,e)=>256*t+e),0)}function u(t,e,s){return t<=e?e:t>=s?s:t}function p(t){return t>=32768?t-65536:t}var c,m,f,y,_,g,v,b,S,w,E,k,R,C,M,L,A,P,x,B;c=new WeakMap,m=new WeakMap,f=new WeakMap,y=new WeakMap,_=new WeakMap,g=new WeakMap,v=new WeakMap,b=new WeakMap,S=new WeakMap,w=new WeakMap,E=new WeakSet,k=function(){if(a(this,S))return a(this,S);const{numberChannels:t}=this.metadata,e=[];for(let s=0;s<t;s++){const t=a(this,c)+d(this.rawData,a(this,y)+8+8*s,4,this.endianness)+8+8,i=[];for(let e=0;e<16;e++){const s=d(this.rawData,t+2*e,2,this.endianness);i.push(p(s))}e.push({adpcmCoefficients:i,gain:d(this.rawData,t+40,2,this.endianness),initialPredictorScale:d(this.rawData,t+42,2,this.endianness),historySample1:d(this.rawData,t+44,2,this.endianness),historySample2:d(this.rawData,t+46,2,this.endianness),loopPredictorScale:d(this.rawData,t+48,2,this.endianness),loopHistorySample1:d(this.rawData,t+50,2,this.endianness),loopHistorySample2:d(this.rawData,t+52,2,this.endianness)})}return n(this,S,e),e},R=new WeakSet,C=function(){const t=d(this.rawData,a(this,m)+2,1,this.endianness),e=d(this.rawData,a(this,f),1,this.endianness),s=d(this.rawData,a(this,f)+1,1,this.endianness),i=[];for(let t=0;t<e;t++){const e=a(this,c)+8+d(this.rawData,a(this,f)+4+8*t+4,4,this.endianness),s=d(this.rawData,a(this,f)+4+8*t+1,1,this.endianness);let n=0;0===s?n=d(this.rawData,e,1,this.endianness):1===s&&(n=d(this.rawData,e+8,1,this.endianness)),i.push({numberChannels:n,type:s})}const n={fileSize:d(this.rawData,8,4,this.endianness),endianness:this.endianness,codec:d(this.rawData,a(this,m),1,this.endianness),loopFlag:d(this.rawData,a(this,m)+1,1,this.endianness),numberChannels:t,sampleRate:d(this.rawData,a(this,m)+4,2,this.endianness),loopStartSample:d(this.rawData,a(this,m)+8,4,this.endianness),totalSamples:d(this.rawData,a(this,m)+12,4,this.endianness),totalBlocks:d(this.rawData,a(this,m)+20,4,this.endianness),blockSize:d(this.rawData,a(this,m)+24,4,this.endianness),samplesPerBlock:d(this.rawData,a(this,m)+28,4,this.endianness),finalBlockSize:d(this.rawData,a(this,m)+32,4,this.endianness),finalBlockSizeWithPadding:d(this.rawData,a(this,m)+40,4,this.endianness),totalSamplesInFinalBlock:d(this.rawData,a(this,m)+36,4,this.endianness),adpcTableSamplesPerEntry:d(this.rawData,a(this,m)+44,4,this.endianness),adpcTableBytesPerEntry:d(this.rawData,a(this,m)+48,4,this.endianness),numberTracks:e,trackDescriptionType:s,trackDescriptions:i};return n.loopStartSample>=n.totalSamples&&(n.loopFlag=0,n.loopStartSample=0,console.warn("The loop start sample in this file is invalid.")),n},M=new WeakSet,L=function(t){const{blockSize:e,totalBlocks:s,numberChannels:i,finalBlockSize:n,finalBlockSizeWithPadding:l}=this.metadata,o=[];for(let a=0;a<i;a++)o.push(new Uint8Array(t===s-1?n:e));let r=t;for(let t=0;t<i;t++){const h=0!==t&&r+1===s?r*i*e+t*l:(r*i+t)*e,d=r+1===s?h+n:h+e,u=this.rawData.slice(a(this,g)+32+h,a(this,g)+32+d);o[t].set(u)}return o},A=new WeakSet,P=function(){if(a(this,b))return a(this,b);const{totalBlocks:t,numberChannels:e}=this.metadata,s=d(this.rawData,a(this,_)+4,4,this.endianness),i=this.rawData.slice(a(this,_)+8,a(this,_)+8+s);let l=0,o=0,r=0;for(let t=0;t<e;t++)o=p(d(i,l,2,this.endianness)),l+=2,r=p(d(i,l,2,this.endianness)),l+=2;const h=[];for(let s=0;s<t;s++){h.push([]);for(let t=0;t<e;t++)s>0&&(o=p(d(i,l,2,this.endianness)),l+=2,r=p(d(i,l,2,this.endianness)),l+=2),h[s].push({yn1:o,yn2:r})}let u=[];for(let t=0;t<e;t++)u.push(h.map((e=>e[t])));return n(this,b,u),u},x=new WeakSet,B=function(t){if(a(this,w)[t])return a(this,w)[t];const{numberChannels:e,totalBlocks:s,totalSamplesInFinalBlock:i,samplesPerBlock:n,codec:o}=this.metadata,r=l(this,E,k).call(this),h=l(this,M,L).call(this,t),c=l(this,A,P).call(this),m=[],f=t===s-1?i:n;for(let t=0;t<e;t++)m.push(new Int16Array(f));for(let a=0;a<e;a++){const{adpcmCoefficients:e}=r[a],i=h[a],n=[];if(2===o){const l=i[0],{yn1:o,yn2:r}=c[a][t];let h=l,d=o,p=r,m=0;for(let t=0;t<f;){let s=0;t%14==0&&(h=i[m++]),s=0==(1&t++)?i[m]>>4:15&i[m++],s>=8&&(s-=16);const a=h>>4<<1;s=1024+((1<<(15&h))*s<<11)+e[u(a,0,15)]*d+e[u(a+1,0,15)]*p>>11,p=d,d=u(s,-32768,32767),n.push(d)}t<s-1&&(c[a][t+1].yn1=n[f-1],c[a][t+1].yn2=n[f-2])}else if(1===o)for(let t=0;t<f;t++){const e=p(d(i,2*t,2,this.endianness));n.push(e)}else{if(0!==o)throw new Error("Invalid codec");for(let t=0;t<f;t++)n.push(256*p(i[t]))}m[a].set(n)}return a(this,w)[t]=m,m},e.Brstm=class{constructor(t){if(i(this,E),i(this,R),i(this,M),i(this,A),i(this,x),i(this,c,void 0),i(this,m,void 0),i(this,f,void 0),i(this,y,void 0),i(this,_,void 0),i(this,g,void 0),i(this,v,void 0),i(this,b,void 0),i(this,S,void 0),i(this,w,void 0),n(this,v,null),n(this,b,null),n(this,S,null),n(this,w,[]),this.rawData=new Uint8Array(t),"RSTM"!==function(t,e,s,a=h){const i=o(t,e,s);return a===r&&i.reverse(),String.fromCharCode(...i)}(this.rawData,0,4))throw new Error("Not a valid BRSTM file");this.endianness=function(t){const e=o(t,4,2);return 255===e[0]&&254===e[1]?r:h}(this.rawData),n(this,c,d(this.rawData,16,4,this.endianness)),n(this,m,a(this,c)+d(this.rawData,a(this,c)+12,4,this.endianness)+8),n(this,f,a(this,c)+d(this.rawData,a(this,c)+20,4,this.endianness)+8),n(this,y,a(this,c)+d(this.rawData,a(this,c)+28,4,this.endianness)+8),n(this,_,d(this.rawData,24,4,this.endianness)),n(this,g,d(this.rawData,32,4,this.endianness)),this.metadata=l(this,R,C).call(this)}getAllSamples(){if(a(this,v))return a(this,v);const{numberChannels:t,totalSamples:e,totalBlocks:s,samplesPerBlock:i}=this.metadata,o=[];for(let s=0;s<t;s++)o.push(new Int16Array(e));for(let e=0;e<s;e++){const s=l(this,x,B).call(this,e);for(let a=0;a<t;a++)o[a].set(s[a],e*i)}return n(this,v,o),o}getBuffer(t,e){return this.getSamples(t,e)}getSamples(t,e){const{numberChannels:s,totalBlocks:a,totalSamples:i,samplesPerBlock:n}=this.metadata,o=Math.max(0,t),r=Math.min(i,t+e),h=Math.max(0,Math.floor(o/n)),d=Math.min(a-1,Math.floor(r/n)),u=[];for(let t=h;t<=d;t++)u.push(l(this,x,B).call(this,t));const p=[];for(let t=0;t<s;t++)p.push(new Int16Array(r-o));for(let t=h;t<=d;t++){const a=t-h;if(t===h&&t===d)for(let t=0;t<s;t++)p[t].set(u[a][t].slice(o-h*n,o-h*n+e),0);else if(t===h)for(let t=0;t<s;t++){const e=u[a][t].slice(o-h*n);p[t].set(e,0)}else if(t===d)for(let i=0;i<s;i++){const s=u[a][i].slice(0,r-u[a][i].length-h*n);s.length+(t*n-o)>p[i].length?p[i].set(s.slice(0,e-(t*n-o)),t*n-o):p[i].set(s,t*n-o)}else for(let e=0;e<s;e++)p[e].set(u[a][e],t*n-o)}return p}}})),a=e((function(e,s){var a=t&&t.__awaiter||function(t,e,s,a){return new(s||(s=Promise))((function(i,n){function l(t){try{r(a.next(t))}catch(t){n(t)}}function o(t){try{r(a.throw(t))}catch(t){n(t)}}function r(t){var e;t.done?i(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(l,o)}r((a=a.apply(t,e||[])).next())}))};Object.defineProperty(s,"__esModule",{value:!0}),s.browserCapabilities=void 0,s.browserCapabilities=function(){return a(this,void 0,void 0,(function*(){let t={sampleRate:!1,streaming:!1,mediaSession:!1};try{let e=new(window.AudioContext||AudioContext)({sampleRate:8e3});t.sampleRate=8e3===e.sampleRate,e.close()}catch(t){console.log("WebAudio sample rate capability detection failed. Assuming fallback.")}try{let e=new Uint8Array(Math.pow(2,16)),s=new Blob([e],{type:"application/octet-stream"}),a=URL.createObjectURL(s),i=yield fetch(a),n=yield i.body;if(!n)throw"could not get body";const l=n.getReader();for(;;){if((yield l.read()).done)break}t.streaming=!0}catch(t){console.log("Streaming capability detection failed. Assuming fallback.")}t.mediaSession="mediaSession"in navigator;var e=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./),s=!!e&&parseInt(e[2],10);return!1!==s&&s>=89&&(t.sampleRate=!1),t}))}})),i=e((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.ARTWORK_URL=e.SILENCE_URL=e.SMASHCUSTOMMUSIC_URL=e.PLAYER_TAG_ID=e.STREAMING_MIN_RESPONSE=void 0,e.STREAMING_MIN_RESPONSE=Math.pow(2,19),e.PLAYER_TAG_ID="brstm_player",e.SMASHCUSTOMMUSIC_URL="https://smashcustommusic.net",e.SILENCE_URL="https://github.com/anars/blank-audio/blob/master/5-seconds-of-silence.mp3?raw=true",e.ARTWORK_URL="https://ssb.wiki.gallery/images/a/a2/SSBU_spirit_Smash_Ball.png"}));var n=function(t,e){let s=this.getChannelData(e);for(let e=0;e<t.length;e++)s[e]=t[e]},l=Object.defineProperty({default:n},"__esModule",{value:!0}),o=e((function(t,e){var s;Object.defineProperty(e,"__esModule",{value:!0}),e.PlayerEvent=void 0,(s=e.PlayerEvent||(e.PlayerEvent={})).start="brstm_start",s.play="brstm_play",s.pause="brstm_pause",s.playPause="brstm_playpause",s.next="brstm_next",s.stop="brstm_stop",s.seek="brstm_seek",s.setLoop="brstm_setloop",s.setVolume="brstm_setvolume",s.buffering="brstm_buffering",s.loading="brstm_loading",s.loaded="brstm_loaded",s.killed="brstm_killed",s.step="brstm_step",s.resetState="brstm_resetstate"}));var r=class{constructor(t,e,s,a){if(this._fromSampleRate=t,this._toSampleRate=e,this._channels=0|s,"object"!=typeof a)throw new Error("inputBuffer is not an object.");if(!(a instanceof Array||a instanceof Float32Array||a instanceof Float64Array))throw new Error("inputBuffer is not an array or a float32 or a float64 array.");this._inputBuffer=a,this._outputBuffer=new Float32Array,this._lastOutput=new Float32Array,this._resampler=this.linerarInterpolationFn,this._ratioWeight=1,this._lastWeight=1,this._tailExists=!1,this.initialize()}initialize(){if(!(this._fromSampleRate>0&&this._toSampleRate>0&&this._channels>0))throw new Error("Invalid settings specified for the resampler.");this._fromSampleRate==this._toSampleRate?(this._resampler=this.bypassResampler,this._ratioWeight=1,this._outputBuffer=this._inputBuffer):(this._ratioWeight=this._fromSampleRate/this._toSampleRate,this._fromSampleRate<this._toSampleRate?(this._resampler=this.linerarInterpolationFn,this._lastWeight=1):(this._resampler=this.multiTapFn,this._tailExists=!1,this._lastWeight=0),this.initializeBuffers())}initializeBuffers(){var t=Math.ceil(this._inputBuffer.length*this._toSampleRate/this._fromSampleRate/this._channels*1.0000004768371582)*this._channels+this._channels;try{this._outputBuffer=new Float32Array(t),this._lastOutput=new Float32Array(this._channels)}catch(t){this._outputBuffer=new Float32Array([]),this._lastOutput=new Float32Array([])}}bypassResampler(t){return t}multiTapFn(t){var e=0;if(t>0){for(var s=this._inputBuffer,a=0,i=[],n=0;n<this._channels;++n)i[0]=0;var l=0,o=0,r=!this._tailExists;this._tailExists=!1;var h=this._outputBuffer,d=0;do{for(r?(a=this._ratioWeight,i.forEach(((t,e)=>{i[e]=0}))):(a=this._lastWeight,i.forEach(((t,e)=>{i[e]=this._lastOutput[e]})),r=!0);a>0&&l<t;){if(!(a>=(o=1+l-d))){i.forEach(((t,e)=>{i[e]+=s[l+e]*a})),d+=a,a=0;break}i.forEach(((t,e)=>{i[e]+=s[l++]*o})),d=l,a-=o}if(!(a<=0)){this._lastWeight=a,i.forEach(((t,e)=>{this._lastOutput[e]=t})),this._tailExists=!0;break}i.forEach((t=>{h[e++]=t/this._ratioWeight}))}while(l<t)}return e}linerarInterpolationFn(t){var e=0;if(t>0){for(var s=this._inputBuffer,a=this._lastWeight,i=0,n=0,l=0,o=(e=0,this._outputBuffer);a<1;a+=this._ratioWeight){i=1-(n=a%1);for(var r=0;r<this._channels;++r)o[e++]=this._lastOutput[r]*i+s[r]*n}for(a-=1,t-=this._channels,l=Math.floor(a)*this._channels;l<t;){i=1-(n=a%1);for(r=0;r<this._channels;++r)o[e++]=s[l+r]*i+s[l+r+this._channels]*n;a+=this._ratioWeight,l=Math.floor(a)*this._channels}for(r=0;r<this._channels;++r)this._lastOutput[r]=s[l++];this._lastWeight=a%1}return e}get outputBuffer(){return this._outputBuffer}get resampler(){return this._resampler}},h=Object.defineProperty({default:r},"__esModule",{value:!0}),d=e((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.awaitMessage=e.powersOf2=e.sleep=void 0;e.sleep=t=>new Promise((e=>setTimeout(e,t))),e.powersOf2=[256,512,1024,2048,4096,8192,16384,32768],e.awaitMessage=function(t){return new Promise((e=>{let s=a=>{a.data===t&&a.isTrusted&&(window.removeEventListener("message",s),e())};window.addEventListener("message",s)}))}})),u=t&&t.__awaiter||function(t,e,s,a){return new(s||(s=Promise))((function(i,n){function l(t){try{r(a.next(t))}catch(t){n(t)}}function o(t){try{r(a.throw(t))}catch(t){n(t)}}function r(t){var e;t.done?i(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(l,o)}r((a=a.apply(t,e||[])).next())}))};var p=function(t){return new Promise((e=>u(this,void 0,void 0,(function*(){let s=!1,a=document.createElement("div");a.setAttribute("style","background: #888a; z-index: 88888; position: fixed; top: 0; bottom: 0; left: 0; right: 0; display: flex; align-items: center; justify-content: center;");let i=document.createElement("div");i.setAttribute("style","display: flex; align-items: center; justify-content: center; flex-direction: column"),i.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" version="1.0"  width="200" height="200" viewBox="0 0 75 75">\n<path d="M39.389,13.769 L22.235,28.606 L6,28.606 L6,47.699 L21.989,47.699 L39.389,62.75 L39.389,13.769z"\nstyle="stroke:#fff;stroke-width:5;stroke-linejoin:round;fill:#fff;"\n/>\n<path d="M48,27.6a19.5,19.5 0 0 1 0,21.4M55.1,20.5a30,30 0 0 1 0,35.6M61.6,14a38.8,38.8 0 0 1 0,48.6" style="fill:none;stroke:#fff;stroke-width:5;stroke-linecap:round"/>\n</svg><h1 style="font-family: sans-serif; color: white; margin: 0;">Tap or click anywhere to enable audio.</h1>',a.appendChild(i),setTimeout((function(){s||document.body.appendChild(a)}),200),t.onstatechange=function(){"running"==t.state&&(e(),a.remove(),s=!0)};try{t.resume()}catch(t){console.error(t)}a.addEventListener("touchend",(function(){return u(this,void 0,void 0,(function*(){yield t.resume(),"running"===t.state&&(e(),a.remove(),s=!0)}))})),a.addEventListener("click",(function(){return u(this,void 0,void 0,(function*(){yield t.resume(),"running"===t.state&&(e(),a.remove(),s=!0)}))})),"running"===t.state&&(e(),a.remove(),s=!0)}))))},c=Object.defineProperty({default:p},"__esModule",{value:!0}),m=s,f=e((function(e,s){var n=t&&t.__awaiter||function(t,e,s,a){return new(s||(s=Promise))((function(i,n){function l(t){try{r(a.next(t))}catch(t){n(t)}}function o(t){try{r(a.throw(t))}catch(t){n(t)}}function r(t){var e;t.done?i(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(l,o)}r((a=a.apply(t,e||[])).next())}))},r=t&&t.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(s,"__esModule",{value:!0}),s.BrstmPlayer=void 0;const u=r(l),p=r(h),f=r(c);function y(t,e,s){let a=[],i=0;for(let e=0;e<t.metadata.numberChannels;e++)a.push(new Int16Array(s));for(;i<s;){let n=t.getSamples(e+i,Math.min(t.metadata.samplesPerBlock,s-i));for(let t=0;t<n.length;t++)a[t].set(n[t],i);i+=Math.min(t.metadata.samplesPerBlock,s-i)}return a}s.BrstmPlayer=class{constructor(){this._state={hasInitialized:!1,capabilities:{},audioContext:new AudioContext,scriptNode:{},gainNode:{},fullyLoaded:!0,loadState:0,playbackCurrentSample:0,brstm:{},brstmBuffer:new ArrayBuffer(0),paused:!1,stopped:!1,enableLoop:!1,loopCount:0,loopFor:Number.MAX_SAFE_INTEGER,streamCancel:!1,playAudioRunning:!1,volume:Number(localStorage.getItem("volumeoverride"))||1,samplesReady:0,isCrossfading:!1,musicEnded:!1,crossfade:!1},this._audio=document.createElement("audio"),this._audio.id=i.PLAYER_TAG_ID,this._audio.src=i.SILENCE_URL,this._audio.loop=!0,document.body.appendChild(this._audio)}sendEvent(t,e={}){this._audio.dispatchEvent(new CustomEvent(t,{detail:e,bubbles:!0}))}sendUpdateStateEvent(){this.sendEvent(o.PlayerEvent.step,{position:this._state.playbackCurrentSample,paused:this._state.paused,volume:this._state.volume,loaded:this._state.samplesReady,looping:this._state.enableLoop})}getResampledSample(t,e,s){return Math.ceil(s/t*e)}loadSongLegacy(t){return n(this,void 0,void 0,(function*(){let e=yield fetch(t),s=yield e.arrayBuffer();this._state.brstm=new m.Brstm(s),this._state.fullyLoaded=!0,this._state.loadState=Number.MAX_SAFE_INTEGER,this._state.samplesReady=Number.MAX_SAFE_INTEGER}))}loadSongStreaming(t){return new Promise(((e,s)=>n(this,void 0,void 0,(function*(){let a,n;this.sendEvent(o.PlayerEvent.loading);try{a=yield fetch(t);let e=yield a.body;if(!e)throw"could not read body";n=e.getReader();let s=a.headers.get("content-length");if(!s)throw"could not read content-length header";this._state.brstmBuffer=new ArrayBuffer(parseInt(s))}catch(t){return s(t)}let l=new Uint8Array(this._state.brstmBuffer),r=0,h=!1,d=0;for(this._state.samplesReady=0,this._state.fullyLoaded=!1,this._state.streamCancel=!1;;){let t;try{t=yield n.read()}catch(t){return void(h?(this.sendEvent(o.PlayerEvent.killed,{streamingDied:!0,buffering:!1,ready:!0}),yield this._state.audioContext.close(),this._state.audioContext={}):s(t))}if(this._state.streamCancel)return yield n.cancel(),void window.postMessage("continueload");if(t.done){if(!h)try{this._state.brstm=new m.Brstm(this._state.brstmBuffer),e(),h=!0}catch(t){return void s(t)}this._state.fullyLoaded=!0,this._state.samplesReady=Number.MAX_SAFE_INTEGER,console.log("File finished streaming");break}if(l.set(t.value,r),r+=t.value.length,this._state.loadState=r,0==d&&r>128){let t=0;65279==256*l[4]+l[5]&&(t=1),d=1==t?16777216*l[112]+65536*l[113]+256*l[114]+l[115]:l[112]+256*l[113]+65536*l[114]+16777216*l[115],d<144&&(d=i.STREAMING_MIN_RESPONSE)}if(!h&&0!=d&&r>d)try{this._state.brstm=new m.Brstm(this._state.brstmBuffer),e(),h=!0}catch(t){return void s(t)}h&&(this._state.samplesReady=Math.floor((this._state.loadState-d)/this._state.brstm.metadata.numberChannels/this._state.brstm.metadata.blockSize)*this._state.brstm.metadata.samplesPerBlock)}}))))}get totalSamples(){return this._state.brstm?this._state.brstm.metadata.totalSamples:-1}get sampleRate(){return this._state.brstm?this._state.brstm.metadata.sampleRate:-1}getSongLength(){return this.totalSamples/this.sampleRate}crossfadeStep(){this.decVolume(.01),this._state.volume<=0&&this.stop()}setVolume(t){this._state.volume=t,this.sendEvent(o.PlayerEvent.setVolume,{volume:t}),this.sendUpdateStateEvent(),this._state.gainNode&&this._state.gainNode.gain.setValueAtTime(this._state.volume,this._state.audioContext.currentTime)}incVolume(t){this.setVolume(Math.min(this._state.volume+t,1))}decVolume(t){this.setVolume(Math.max(this._state.volume-t,0))}seek(t){this._state.playbackCurrentSample=Math.floor(t),this.sendEvent(o.PlayerEvent.seek,{toSample:this._state.playbackCurrentSample}),this.sendUpdateStateEvent()}playPause(){this._state.paused=!this._state.paused,this._state.audioContext[this._state.paused?"suspend":"resume"](),this._state.capabilities.mediaSession&&(navigator.mediaSession.playbackState="playing"===navigator.mediaSession.playbackState?"paused":"playing"),this.sendEvent(o.PlayerEvent.playPause,{playing:"playing"===navigator.mediaSession.playbackState}),this.sendUpdateStateEvent()}setLoop(t,e){this._state.loopType=t,this._state.loopFor=e||Number.MAX_SAFE_INTEGER,this.sendEvent(o.PlayerEvent.setLoop,{loopType:t,loopFor:e}),this.sendUpdateStateEvent()}stop(){this._state.stopped=!0,this._state.musicEnded?this.sendEvent(o.PlayerEvent.next):this.sendEvent(o.PlayerEvent.stop)}shouldLoop(){let t=!1;switch(this._state.loopType){case"count":t=this._state.loopCount<this._state.loopFor;break;case"time":t=this._state.loopCount*(this.totalSamples/this.sampleRate)<this._state.loopFor;break;case"none":t=!1;break;case"infinite":return!0}if(!t){if(this._state.crossfade)return this._state.isCrossfading=!0,!0;this._state.musicEnded=!0}return this._state.loopCount+=1,t}restartState(){this._state=Object.assign(Object.assign({},this._state),{volume:1,isCrossfading:!1,loopCount:0,stopped:!1})}play(t,e){return n(this,void 0,void 0,(function*(){if(this.sendEvent(o.PlayerEvent.play,{url:t}),this.restartState(),this._state.capabilities=yield(0,a.browserCapabilities)(),e&&(this._state.crossfade=e.crossfade,this._state.loopType=e.loopType,e.loopFor&&(this._state.loopFor=e.loopFor),e.mediaControls&&(this._setMediaSessionData(e.song),this._state.capabilities.mediaSession&&(navigator.mediaSession.playbackState="playing"))),this._state.stopped=!1,console.log(`Playing ${t}`),this.sendEvent(o.PlayerEvent.buffering,{buffering:!0}),this._state.hasInitialized||this.sendEvent(o.PlayerEvent.start,{loaded:this._state.samplesReady}),this._state.playAudioRunning)return;this._state.playAudioRunning=!0,this._state.fullyLoaded||(console.log("Cancelling last stream..."),this._state.streamCancel=!0,yield(0,d.awaitMessage)("continueload"),console.log("Done.")),this._state.audioContext&&(yield this._state.audioContext.close(),this._state.audioContext={}),this._state.playbackCurrentSample=0,this._state.paused=!1,this.sendEvent(o.PlayerEvent.resetState,{ready:!1,position:0,samples:1e6,loaded:0,volume:this._state.volume,paused:!1,buffering:!1,sampleRate:44100,streamingDied:!1});try{yield(this._state.capabilities.streaming?this.loadSongStreaming.bind(this):this.loadSongLegacy.bind(this))(t)}catch(t){return this.sendEvent(o.PlayerEvent.killed,{streamingDied:!0,buffering:!1,ready:!0}),console.error(t),void(this._state.playAudioRunning=!1)}this._state.audioContext=new window.AudioContext(this._state.capabilities.sampleRate?{sampleRate:this._state.brstm.metadata.sampleRate}:{}),this._state.enableLoop=1===this._state.brstm.metadata.loopFlag,yield(0,f.default)(this._state.audioContext),this._state.capabilities.streaming&&(yield(0,d.sleep)(1e3)),this._state.scriptNode=this._state.audioContext.createScriptProcessor(0,0,2);let s=this._state.scriptNode.bufferSize;s=this._state.capabilities.sampleRate?s:this.getResampledSample(this._state.audioContext.sampleRate,this._state.brstm.metadata.sampleRate,s);let i=s;this._state.capabilities.sampleRate||(i+=20),this.sendEvent(o.PlayerEvent.loaded,{ready:!0,samples:this._state.brstm.metadata.totalSamples,sampleRate:this._state.brstm.metadata.sampleRate}),this._state.playAudioRunning=!1,this._state.scriptNode.onaudioprocess=t=>{if(!0===this._state.stopped)return;this.sendUpdateStateEvent();let e,a=t.outputBuffer;if(a.copyToChannel||(a.copyToChannel=u.default),this._state.playbackCurrentSample+s+1024>this._state.samplesReady)return this.sendEvent(o.PlayerEvent.buffering,{buffering:!0}),console.log("Buffering...."),a.copyToChannel(new Float32Array(this._state.scriptNode.bufferSize).fill(0),0),void a.copyToChannel(new Float32Array(this._state.scriptNode.bufferSize).fill(0),1);if(this.sendEvent(o.PlayerEvent.buffering,{buffering:!1}),this._state.paused)return a.copyToChannel(new Float32Array(this._state.scriptNode.bufferSize).fill(0),0),void a.copyToChannel(new Float32Array(this._state.scriptNode.bufferSize).fill(0),1);if(this._state.playbackCurrentSample+i<this._state.brstm.metadata.totalSamples)this._state.isCrossfading&&this.crossfadeStep(),e=y(this._state.brstm,this._state.playbackCurrentSample,i),this._state.playbackCurrentSample+=s;else if(this.shouldLoop()){e=y(this._state.brstm,this._state.playbackCurrentSample,this._state.brstm.metadata.totalSamples-this._state.playbackCurrentSample);let t=e[0].length;console.log(this._state.brstm.metadata.totalSamples-this._state.playbackCurrentSample,i-t);let a=y(this._state.brstm,this._state.brstm.metadata.loopStartSample,i-t);for(let t=0;t<e.length;t++){let s=new Int16Array(i).fill(0);s.set(e[t]),s.set(a[t],e[t].length),e[t]=s}this._state.playbackCurrentSample=this._state.brstm.metadata.loopStartSample+s-t}else{e=y(this._state.brstm,this._state.playbackCurrentSample,this._state.brstm.metadata.totalSamples-this._state.playbackCurrentSample-1);for(let t=0;t<e.length;t++){let s=new Int16Array(i).fill(0);s.set(e[t]),e[t]=s}this._state.playbackCurrentSample=0,this._state.paused=!0,this.stop()}e.length>2&&(e=[e[0],e[1]]),1===e.length&&(e=[e[0],e[0]]);for(let t=0;t<e.length;t++){let s=new Float32Array(i);for(let a=0;a<i;a++)s[a]=e[t][a]/32768;if(!this._state.capabilities.sampleRate){let t=new p.default(this._state.brstm.metadata.sampleRate,this._state.audioContext.sampleRate,1,s);t.resampler(i),s=new Float32Array(t.outputBuffer),s.length>this._state.scriptNode.bufferSize&&(s=s.slice(0,this._state.scriptNode.bufferSize))}a.copyToChannel(s,t)}},this._state.gainNode=this._state.audioContext.createGain(),this._state.scriptNode.connect(this._state.gainNode),this._state.gainNode.connect(this._state.audioContext.destination),this._state.gainNode.gain.setValueAtTime(this._state.volume,this._state.audioContext.currentTime)}))}_setMediaSessionData(t){return n(this,void 0,void 0,(function*(){this._state.capabilities.mediaSession&&this._audio.play().then((e=>{t&&(navigator.mediaSession.metadata=new MediaMetadata({title:t.name,album:t.game_name,artist:t.uploader,artwork:[{src:i.ARTWORK_URL,type:"image/png",sizes:"560x544"}]})),navigator.mediaSession.setActionHandler("play",(()=>{this.playPause()})),navigator.mediaSession.setActionHandler("pause",(()=>{this.playPause()})),navigator.mediaSession.setActionHandler("stop",(()=>{this.stop()}))})).catch((t=>{console.error(t)}))}))}}})),y=e((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.runGestureEngine=e.getInstance=void 0;class s{constructor(){this.currentlyGesturing=!1,this.activeArea="",this.activeAreaElem=null,this.operationListeners=new Map,this.finishedListeners=new Map}sanitize(t,e){let s=this.activeAreaElem.getBoundingClientRect(),a=t-s.x,i=e-s.y;return a<0&&(a=0),i<0&&(i=0),a>s.width&&(a=s.width),i>s.height&&(i=s.height),[a,i]}fireOp(t,e,s){if(this.operationListeners.has(t)){let a=this.operationListeners.get(t);a&&a.forEach((t=>{t(e,s)}))}}fireFin(t,e,s){if(this.finishedListeners.has(t)){let a=this.operationListeners.get(t);a&&a.forEach((t=>{t(e,s)}))}}registerOpEvent(t,e){if(this.operationListeners.has(t)){let s=this.operationListeners.get(t);s&&(s.push(e),this.operationListeners.set(t,s))}else this.operationListeners.set(t,[e])}registerFinEvent(t,e){if(this.finishedListeners.has(t)){let s=this.finishedListeners.get(t);s&&(s.push(e),this.finishedListeners.set(t,s))}else this.finishedListeners.set(t,[e])}runGestureEngine(){i()}}let a=new s;function i(){document.addEventListener("mousedown",(function(t){if(t.target.dataset.gestureHitzone){a.currentlyGesturing=!0,a.activeArea=t.target.dataset.gestureHitzone,a.activeAreaElem=t.target;let[e,s]=a.sanitize(t.clientX,t.clientY);a.fireOp(a.activeArea,e,s)}})),document.addEventListener("mousemove",(function(t){if(a.currentlyGesturing){let[e,s]=a.sanitize(t.clientX,t.clientY);a.fireOp(a.activeArea,e,s)}})),document.addEventListener("mouseup",(function(t){if(a.currentlyGesturing){let[e,s]=a.sanitize(t.clientX,t.clientY);a.fireFin(a.activeArea,e,s),a.currentlyGesturing=!1,a.activeAreaElem=null,a.activeArea=""}}))}e.getInstance=function(){return null==a&&(a=new s),a},e.runGestureEngine=i})),_=e((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.runGUI=void 0;const s=y.getInstance();let a={display:!1,position:0,samples:1e6,loaded:5e5,volume:1,paused:!1,ready:!1,buffering:!1,sampleRate:48e3,looping:!1,streamingDied:!1},n={volume:null,position:null},l={},r=null,h=null,d=null,u=-30;function p(t){try{t.preventDefault()}catch(t){}if(t.targetTouches.length>0){let e=t.targetTouches[0].target.getBoundingClientRect(),s=t.targetTouches[0].clientY+t.targetTouches[0].radiusY-e.top;s<5&&(s=0),s>80&&(s=84);let i=1-s/84;n.volume=i,"touchend"===t.type&&(a.volume=n.volume,l.setVolume(n.volume),n.volume=null,localStorage.setItem("volumeoverride",i)),P()}else"touchend"===t.type&&(a.volume=n.volume,l.setVolume(n.volume),n.volume=null)}function c(t){try{t.preventDefault()}catch(t){}if(t.targetTouches.length>0){let e=t.targetTouches[0].target.getBoundingClientRect(),s=t.targetTouches[0].clientX+t.targetTouches[0].radiusX-e.left;if(s<5&&(s=0),s>254&&(s=254),s=Math.round(s),s===u)return;u=s;let i=a.samples*(s/254);i<a.loaded&&(n.position=i),"touchend"===t.type&&(l.seek(n.position),n.position=null),P()}else"touchend"===t.type&&(l.seek(n.position),n.position=null)}function m(t,e){let s=Math.round(t),i=a.samples*(s/254);i<a.loaded&&(n.position=i),P()}function f(t,e){let s=Math.round(t),i=a.samples*(s/254);i<a.loaded&&(n.position=i),l.seek(i),n.position=null,P()}function _(t,e){e=Math.round(e),n.volume=1-e/84,P()}function g(t,e){let s=1-(e=Math.round(e))/84;n.volume=null,localStorage.setItem("volumeoverride",s),l.setVolume(s),P()}e.runGUI=function(t){!function(){let t=document.getElementById(i.PLAYER_TAG_ID);t&&(t.addEventListener(o.PlayerEvent.step,(t=>{a=Object.assign(Object.assign({},a),{position:t.detail.position,paused:t.detail.paused,volume:t.detail.volume,loaded:t.detail.loaded,looping:t.detail.looping}),P()})),t.addEventListener(o.PlayerEvent.killed,(t=>{a=Object.assign(Object.assign({},a),{streamingDied:t.detail.streamingDied,buffering:t.detail.buffering,ready:t.detail.ready}),A()})),t.addEventListener(o.PlayerEvent.setVolume,(t=>{a.volume=t.detail.volume,P()})),t.addEventListener(o.PlayerEvent.seek,(t=>{a.position=t.detail.toSample,P()})),t.addEventListener(o.PlayerEvent.playPause,(t=>{a.paused=t.detail.playing,P()})),t.addEventListener(o.PlayerEvent.setLoop,(t=>{a.looping=t.detail.loop,P()})),t.addEventListener(o.PlayerEvent.stop,(t=>{A()})),t.addEventListener(o.PlayerEvent.start,(t=>{a.loaded=t.detail.loaded,a.display=!0,P()})),t.addEventListener(o.PlayerEvent.resetState,(t=>{a=Object.assign(Object.assign({},a),{ready:t.detail.ready,position:t.detail.position,samples:t.detail.samples,loaded:t.detail.loaded,volume:t.detail.volume,paused:t.detail.paused,buffering:t.detail.buffering,sampleRate:t.detail.sampleRate,streamingDied:t.detail.streamingDied}),P()})),t.addEventListener(o.PlayerEvent.loaded,(t=>{a=Object.assign(Object.assign({},a),{ready:t.detail.ready,samples:t.detail.samples,sampleRate:t.detail.sampleRate}),P()})),t.addEventListener(o.PlayerEvent.buffering,(t=>{a.buffering=t.detail.buffering,P()})))}(),l=t,d=document.createElement("div"),d.style.display="none",d.classList.add("guiholder"),d.innerHTML='\n<div class="error" style="display: none">\n    <h3>Playback failed!</h3>\n    <h3>Reload the page and try again.</h3>\n    <h3>If the issue continues, contact us.</h3>\n</div>\n<div id="gui-loading-bar">\n    <div id="gui-inner-loading-bar"></div>\n</div>\n<div class="guistate" data-guistate="preload">\n    <h3>Loading song...</h3>\n</div>\n<div class="guistate" data-guistate="ready">\n    <div id="pl-pause-play">\n        <svg width="48" height="48" viewBox="0 0 48 48" id="pl-play">\n            <path d="M 10, 10 l 0, 28 l 28, -14" fill="white"></path>\n        </svg>\n        <svg width="48" height="48" viewBox="0 0 48 48" id="pl-pause" style="display: none;">\n            <path d="M 10, 10 l 0, 28 l 10, 0 l 0, -28 M 28, 10 l 0, 28 l 10, 0 l 0, -28" fill="white"></path>\n        </svg>\n    </div>\n    <canvas id="pl-volume" width="16" height="84" data-gesture-hitzone="volume"></canvas>\n    <div id="pl-timing">\n        <span id="pl-time-start">0:00</span>\n        <span id="pl-time-end"  >0:00</span>\n    </div>\n    <canvas id="pl-seek" width="254" height="16" data-gesture-hitzone="seek"></canvas>\n    <div id="pl-loop">\n        <input type="checkbox" id="pl-loop-box" style="width: 16px; height: 16px; margin: 0;">\n        <span class="pl-loop-text">Enable loop</span>\n        <a class="pl-loop-text" target="_blank" href="https://smashcustommusic.net/feedback/">Send feedback</a>\n        <a class="pl-loop-text" target="_blank" href="https://github.com/rphsoftware/revolving-door">v2 by Rph</a>\n    </div>\n</div>',document.body.appendChild(d),r=document.querySelector("#pl-volume").getContext("2d"),h=document.querySelector("#pl-seek").getContext("2d"),document.querySelector("#pl-volume").addEventListener("touchstart",p),document.querySelector("#pl-volume").addEventListener("touchmove",p),document.querySelector("#pl-volume").addEventListener("touchend",p),document.querySelector("#pl-seek").addEventListener("touchstart",c),document.querySelector("#pl-seek").addEventListener("touchmove",c),document.querySelector("#pl-seek").addEventListener("touchend",c),document.querySelector("#pl-pause-play").addEventListener("click",(function(){l.playPause(),P()})),document.querySelector("#pl-loop-box").addEventListener("input",(function(){a.looping=document.querySelector("#pl-loop-box").checked,l.setLoop(a.looping)})),d.addEventListener("drag",(function(t){t.preventDefault()})),s.runGestureEngine(),s.registerOpEvent("seek",m),s.registerFinEvent("seek",f),s.registerOpEvent("volume",_),s.registerFinEvent("volume",g)};let v=null,b=null,S=-1,w=-1,E=null,k=-1,R=-1,C=null,M=-1,L=null;function A(){d&&(a.display=!1,d.style.display="none")}function P(){if(a.display&&(d.style.display="block"),d){L!==a.streamingDied&&(d.querySelector(".error").style.display=a.streamingDied?"flex":"none",L=a.streamingDied);let t=a.buffering||!a.ready;if(v!==t&&(d.querySelector("#gui-loading-bar").dataset.exists=t,v=t),b!==a.ready&&(d.querySelector('.guistate[data-guistate="preload"]').style.display=a.ready?"none":"block",d.querySelector('.guistate[data-guistate="ready"]').style.display=a.ready?"grid":"none",b=a.ready),!a.ready)return;let e=Math.round(84-84*a.volume);null!==n.volume&&(e=Math.round(84-84*n.volume)),e!==S&&(r.fillStyle="#444",r.fillRect(0,0,16,84),r.fillStyle="hsl(200, 85%, 55%)",r.fillRect(0,e,16,84),S=e);let s=Math.ceil(a.position/a.samples*254);null!==n.position&&(s=Math.ceil(n.position/a.samples*254));let i=Math.ceil(a.loaded/a.samples*254);s===w&&i===M||(h.fillStyle="#222",h.fillRect(0,0,254,16),h.fillStyle="#666",h.fillRect(0,0,Math.min(254,i),16),h.fillStyle="hsl(200, 85%, 55%)",h.fillRect(0,0,Math.min(254,s),16),w=s,M=i),E!==a.paused&&(d.querySelector("#pl-pause").style.display=a.paused?"none":"block",d.querySelector("#pl-play").style.display=a.paused?"block":"none",E=a.paused);let l=Math.floor(a.samples/a.sampleRate),o=Math.floor(a.position/a.sampleRate);null!==n.position&&(o=Math.floor(n.position/a.sampleRate)),l!==k&&(d.querySelector("#pl-time-end").innerText=`${Math.floor(l/60)}:${(l%60).toString().padStart(2,"0")}`,k=l),o!==R&&(d.querySelector("#pl-time-start").innerText=`${Math.floor(o/60)}:${(o%60).toString().padStart(2,"0")}`,R=o),C!==a.looping&&(d.querySelector("#pl-loop-box").checked=a.looping,C=a.looping)}}}));let g=new f.BrstmPlayer;_.runGUI(g),window.player=g}();
